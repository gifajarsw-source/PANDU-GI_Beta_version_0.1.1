<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>PANDU-GI | JARDGI System</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root[data-theme="light"] { --bg: #f8fafc; --surface: #ffffff; --text: #0f172a; --border: #e2e8f0; }
        :root[data-theme="dark"] { --bg: #0f172a; --surface: #1e293b; --text: #f1f5f9; --border: #334155; }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        /* LOGIN SCREEN */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; padding: 20px; }
        .logo { font-size: 32px; font-weight: 800; color: #2563eb; margin-bottom: 30px; letter-spacing: -1px; }
        .search-box { width: 100%; max-width: 400px; background: var(--surface); border: 1px solid var(--border); border-radius: 24px; padding: 12px 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .search-input { width: 100%; border: none; font-size: 16px; background: transparent; color: var(--text); }
        .unit-list { width: 100%; max-width: 400px; margin-top: 10px; background: var(--surface); border-radius: 16px; border: 1px solid var(--border); display: none; max-height: 300px; overflow-y: auto; }
        .unit-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .unit-item:active { background: #eff6ff; }
        
        /* DASHBOARD */
        #dashboard { display: none; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-card { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); text-align: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .menu-card:active { transform: scale(0.98); border-color: #2563eb; }
        .icon { font-size: 28px; margin-bottom: 10px; display: block; }
        .title { font-weight: 700; font-size: 14px; margin-bottom: 2px; }
        .desc { font-size: 11px; color: #64748b; }

        /* SECTIONS */
        .section { display: none; padding: 20px; }
        .section.active { display: block; }
        
        .card { background: var(--surface); border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 12px; }
        .label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .val { font-size: 14px; white-space: pre-line; margin-bottom: 8px; }
        
        /* UTILS */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 700; font-size: 13px; cursor: pointer; margin-bottom: 10px; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-danger { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
        .btn-reset { margin-top: 30px; background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 8px 15px; border-radius: 20px; font-size: 11px; cursor: pointer; }
        
        input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; background: var(--surface); color: var(--text); font-family: inherit; }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-end; justify-content: center; z-index: 100; }
        .modal-content { background: var(--surface); width: 100%; max-width: 500px; padding: 20px; border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto; }
        
        .header-nav { display: none; padding: 15px 20px; background: var(--surface); border-bottom: 1px solid var(--border); justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
    </style>
</head>
<body>

<div id="login-screen">
    <div style="font-size:24px; font-weight:800; color:#2563eb; margin-bottom:20px;">PANDU-GI</div>
    
    <div class="search-box">
        <input type="text" id="search-input" class="search-input" placeholder="Pilih Gardu Induk..." onclick="showList()" oninput="filterList()">
    </div>
    
    <div id="unit-list" class="unit-list"></div>
    
    <p style="margin-top:20px; font-size:12px; color:#94a3b8">Klik kolom diatas untuk memilih</p>

    <button class="btn-reset" onclick="hardReset()">‚Üª RESET APLIKASI (TEKAN JIKA ERROR)</button>
</div>

<div id="navbar" class="header-nav">
    <div style="font-weight:800; color:#2563eb;">PANDU-GI</div>
    <button onclick="goHome()" style="background:#f1f5f9; border:none; padding:6px 12px; border-radius:15px; font-size:12px; font-weight:700;">&larr; Menu</button>
</div>

<div id="dashboard">
    <div style="margin-bottom:20px;">
        <h2 style="margin:0; font-size:18px;">Hallo, Petugas JARDGI</h2>
        <div style="font-size:12px; color:#64748b" id="active-unit-name">...</div>
    </div>

    <div class="grid">
        <div class="menu-card" onclick="openPage('page-ann')">
            <span class="icon">üîî</span>
            <div class="title">Annunciator</div>
            <div class="desc">Cari Alarm</div>
        </div>
        <div class="menu-card" onclick="openPage('page-sop')">
            <span class="icon">üìò</span>
            <div class="title">Buku SOP</div>
            <div class="desc">Simpan Offline</div>
        </div>
        <div class="menu-card" onclick="openPage('page-asset')">
            <span class="icon">‚ö°</span>
            <div class="title">Data Peralatan</div>
            <div class="desc">Simpan Offline</div>
        </div>
        <div class="menu-card" onclick="openPage('page-cloud')">
            <span class="icon">‚òÅÔ∏è</span>
            <div class="title">Akses Database</div>
            <div class="desc">Google Drive</div>
        </div>
        <div class="menu-card" onclick="openPage('page-backup')">
            <span class="icon">üíæ</span>
            <div class="title">Backup Restore</div>
            <div class="desc">JSON Data</div>
        </div>
        <div class="menu-card" onclick="openPage('page-contact')">
            <span class="icon">üìû</span>
            <div class="title">Kontak</div>
            <div class="desc">Nomor Penting</div>
        </div>
    </div>
    
    <div style="text-align:center; margin-top:30px;">
        <button onclick="logout()" style="background:none; border:none; color:#ef4444; font-size:12px; cursor:pointer;">[ Keluar / Ganti Unit ]</button>
    </div>
</div>

<div id="page-ann" class="section">
    <input type="text" id="search-ann" placeholder="Cari Alarm..." oninput="renderAnn()">
    <button class="btn btn-primary" onclick="openModal('modal-ann')">+ Tambah Alarm</button>
    <div id="list-ann"></div>
</div>

<div id="page-sop" class="section">
    <div class="card">
        <div class="label">Simpan SOP (Offline)</div>
        <input type="text" id="sop-name" placeholder="Judul SOP">
        <input type="file" id="sop-file" accept="application/pdf">
        <button class="btn btn-primary" onclick="saveFile('sops', 'sop-name', 'sop-file')">Simpan PDF</button>
    </div>
    <div id="list-sops"></div>
</div>

<div id="page-asset" class="section">
    <div class="card">
        <div class="label">Simpan Manual Book (Offline)</div>
        <input type="text" id="asset-name" placeholder="Judul Dokumen">
        <input type="file" id="asset-file" accept="application/pdf">
        <button class="btn btn-primary" onclick="saveFile('assets', 'asset-name', 'asset-file')">Simpan PDF</button>
    </div>
    <div id="list-assets"></div>
</div>

<div id="page-cloud" class="section">
    <div class="card" style="text-align:center; padding:30px;">
        <div style="font-size:40px; margin-bottom:10px">üìÇ</div>
        <h3>Google Drive Utama</h3>
        <p style="font-size:12px; color:#64748b; margin-bottom:20px;">Akses seluruh database Gardu Induk (SOP, Asset, dll).</p>
        <button class="btn btn-primary" onclick="window.open('https://drive.google.com/drive/folders/13vT0iXCJLjer9sMS5VWI5jjchFk4ntmo?usp=sharing', '_blank')">Buka Google Drive ‚ÜóÔ∏è</button>
    </div>
</div>

<div id="page-backup" class="section">
    <div class="card">
        <h3>Export / Import</h3>
        <button class="btn btn-primary" onclick="exportJSON()">Export Data JSON ‚¨áÔ∏è</button>
        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">
        <div class="label">Restore Data</div>
        <input type="file" id="json-file" accept=".json">
        <button class="btn btn-success" onclick="importJSON()">Restore Data JSON</button>
    </div>
</div>

<div id="page-contact" class="section">
    <button class="btn btn-primary" onclick="openModal('modal-contact')">+ Tambah Kontak</button>
    <div id="list-contact"></div>
</div>

<div id="modal-ann" class="modal">
    <div class="modal-content">
        <h3>Form Alarm</h3>
        <input type="hidden" id="ann-id">
        <label class="label">Unit</label><input id="ann-unit">
        <label class="label">Nama Alarm</label><input id="ann-name">
        <label class="label">Indikasi</label><textarea id="ann-ind"></textarea>
        <label class="label">Penyebab</label><textarea id="ann-cause"></textarea>
        <label class="label">Tindakan</label><textarea id="ann-act"></textarea>
        <button class="btn btn-primary" onclick="saveAnn()">Simpan</button>
        <button class="btn btn-danger" onclick="document.getElementById('modal-ann').style.display='none'">Batal</button>
    </div>
</div>

<div id="modal-contact" class="modal">
    <div class="modal-content">
        <h3>Kontak</h3>
        <input type="hidden" id="cont-id">
        <label class="label">Nama</label><input id="cont-name">
        <label class="label">Nomor HP</label><input type="tel" id="cont-num">
        <button class="btn btn-primary" onclick="saveCont()">Simpan</button>
        <button class="btn btn-danger" onclick="document.getElementById('modal-contact').style.display='none'">Batal</button>
    </div>
</div>

<script>
// --- DATA AWAL ---
const UNITS = [
    "GI 150 KV FAJAR SURYAWISESA", "GI 150 KV GANDAMEKAR", "GI 150 KV CIKARANG",
    "GI 150 KV JABABEKA", "GI 150 KV RAJAPAKSI", "GI 150 KV PONCOL BARU",
    "GI 150 KV TAMBUN", "GIS 150 KV MARGAHAYU", "GISTET 500 KV NEW TAMBUN",
    "GITET 500 KV MUARATAWAR", "GIS 150 KV NEW TAMBUN"
];

let db = { anns: [], conts: [] };
let activeUnit = localStorage.getItem('pandu_unit');
let idb;

// --- INIT ---
if(activeUnit) {
    initApp(activeUnit);
} else {
    renderList();
}

function renderList() {
    const list = document.getElementById('unit-list');
    list.innerHTML = "";
    UNITS.forEach(u => {
        const div = document.createElement('div');
        div.className = 'unit-item';
        div.innerText = u;
        div.onclick = () => initApp(u);
        list.appendChild(div);
    });
}

function showList() { document.getElementById('unit-list').style.display = 'block'; }
function filterList() {
    const key = document.getElementById('search-input').value.toLowerCase();
    const items = document.querySelectorAll('.unit-item');
    items.forEach(el => {
        el.style.display = el.innerText.toLowerCase().includes(key) ? 'flex' : 'none';
    });
}

function hardReset() {
    if(confirm("Hapus semua data & reset aplikasi?")) {
        localStorage.clear();
        indexedDB.deleteDatabase("PanduGI_DB");
        location.reload();
    }
}

// --- LOGIC UTAMA ---
function initApp(unitName) {
    activeUnit = unitName;
    localStorage.setItem('pandu_unit', unitName);
    
    // Load Text Data
    const saved = localStorage.getItem('db_'+unitName);
    if(saved) {
        try { db = JSON.parse(saved); } catch(e) { db = {anns:[], conts:[]} }
    } else {
        db = {anns:[], conts:[]}
    }

    // Init DB File
    const req = indexedDB.open("PanduGI_DB", 1);
    req.onupgradeneeded = e => {
        const d = e.target.result;
        if(!d.objectStoreNames.contains('sops')) d.createObjectStore('sops', {keyPath:'id', autoIncrement:true});
        if(!d.objectStoreNames.contains('assets')) d.createObjectStore('assets', {keyPath:'id', autoIncrement:true});
    };
    req.onsuccess = e => { idb = e.target.result; };

    // UI Switch
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('navbar').style.display = 'flex';
    document.getElementById('active-unit-name').innerText = unitName;
}

function goHome() {
    document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
    document.getElementById('dashboard').style.display = 'block';
}

function openPage(id) {
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById(id).classList.add('active');
    if(id==='page-ann') renderAnn();
    if(id==='page-contact') renderCont();
    if(id==='page-sop') renderFiles('sops', 'list-sops');
    if(id==='page-asset') renderFiles('assets', 'list-assets');
}

function logout() {
    if(confirm("Keluar dari unit ini?")) {
        localStorage.removeItem('pandu_unit');
        location.reload();
    }
}

function openModal(id) {
    document.getElementById(id).style.display = 'flex';
    // Clear inputs
    const inputs = document.getElementById(id).querySelectorAll('input, textarea');
    inputs.forEach(i => i.value = '');
}

// --- CRUD ANNUNCIATOR ---
function saveAnn() {
    const item = {
        id: document.getElementById('ann-id').value || Date.now(),
        unit: document.getElementById('ann-unit').value,
        name: document.getElementById('ann-name').value,
        ind: document.getElementById('ann-ind').value,
        cause: document.getElementById('ann-cause').value,
        act: document.getElementById('ann-act').value
    };
    if(!item.name) return alert("Nama wajib diisi");
    
    const idx = db.anns.findIndex(x => x.id == item.id);
    if(idx > -1) db.anns[idx] = item; else db.anns.unshift(item);
    
    saveLocal();
    document.getElementById('modal-ann').style.display = 'none';
    renderAnn();
}

function renderAnn() {
    const list = document.getElementById('list-ann');
    const key = document.getElementById('search-ann').value.toLowerCase();
    list.innerHTML = '';
    
    db.anns.filter(x => (x.name+x.ind+x.cause).toLowerCase().includes(key)).forEach(x => {
        list.innerHTML += `
            <div class="card">
                <div style="display:flex; justify-content:space-between">
                    <div class="label">${x.unit}</div>
                    <div>
                        <button onclick="editAnn(${x.id})">‚úèÔ∏è</button>
                        <button onclick="delAnn(${x.id})">üóëÔ∏è</button>
                    </div>
                </div>
                <div style="font-weight:800; color:#2563eb; margin-bottom:10px">${x.name}</div>
                <div class="label">Indikasi</div><div class="val">${x.ind}</div>
                <div class="label">Penyebab</div><div class="val">${x.cause}</div>
                <div class="label">Tindakan</div><div class="val">${x.act}</div>
            </div>
        `;
    });
}

function editAnn(id) {
    const item = db.anns.find(x => x.id == id);
    document.getElementById('ann-id').value = item.id;
    document.getElementById('ann-unit').value = item.unit;
    document.getElementById('ann-name').value = item.name;
    document.getElementById('ann-ind').value = item.ind;
    document.getElementById('ann-cause').value = item.cause;
    document.getElementById('ann-act').value = item.act;
    document.getElementById('modal-ann').style.display = 'flex';
}

function delAnn(id) {
    if(confirm("Hapus?")) {
        db.anns = db.anns.filter(x => x.id != id);
        saveLocal(); renderAnn();
    }
}

// --- CRUD CONTACT ---
function saveCont() {
    const item = {
        id: Date.now(),
        name: document.getElementById('cont-name').value,
        num: document.getElementById('cont-num').value
    };
    if(!item.name) return;
    db.conts.push(item);
    saveLocal();
    document.getElementById('modal-contact').style.display = 'none';
    renderCont();
}

function renderCont() {
    const list = document.getElementById('list-contact');
    list.innerHTML = '';
    db.conts.forEach(x => {
        list.innerHTML += `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                <div>
                    <div style="font-weight:700">${x.name}</div>
                    <a href="tel:${x.num}" style="color:#2563eb">${x.num}</a>
                </div>
                <button onclick="delCont(${x.id})" style="background:#fee2e2; border:none; padding:5px 10px; border-radius:5px">X</button>
            </div>
        `;
    });
}

function delCont(id) {
    db.conts = db.conts.filter(x => x.id != id);
    saveLocal(); renderCont();
}

// --- FILE SYSTEM (SIMPLIFIED) ---
function saveFile(store, nameId, fileId) {
    const name = document.getElementById(nameId).value;
    const file = document.getElementById(fileId).files[0];
    if(!name || !file) return alert("Data kurang lengkap");
    
    const reader = new FileReader();
    reader.onload = e => {
        const tx = idb.transaction(store, 'readwrite');
        tx.objectStore(store).add({
            name: name,
            blob: new Blob([e.target.result], {type: 'application/pdf'}),
            unit: activeUnit,
            date: new Date().toLocaleDateString()
        });
        tx.oncomplete = () => { alert("Tersimpan!"); document.getElementById(nameId).value=''; };
    };
    reader.readAsArrayBuffer(file);
}

function renderFiles(store, listId) {
    if(!idb) return setTimeout(()=>renderFiles(store, listId), 500);
    const list = document.getElementById(listId);
    list.innerHTML = "Loading...";
    
    const tx = idb.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    
    req.onsuccess = e => {
        list.innerHTML = "";
        const files = e.target.result.filter(x => x.unit === activeUnit);
        if(files.length === 0) list.innerHTML = "Belum ada file.";
        
        files.forEach(f => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <div><b>${f.name}</b><br><small>${f.date}</small></div>
                    <div>
                        <button onclick="openPdf('${store}', ${f.id})">Buka</button>
                        <button onclick="delPdf('${store}', ${f.id})">Hapus</button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    };
}

function openPdf(store, id) {
    const tx = idb.transaction(store, 'readonly');
    tx.objectStore(store).get(id).onsuccess = e => {
        const file = e.target.result;
        const url = URL.createObjectURL(file.blob);
        // Buka di tab baru (Native PDF Viewer HP)
        window.open(url, '_blank');
    };
}

function delPdf(store, id) {
    if(confirm("Hapus file?")) {
        const tx = idb.transaction(store, 'readwrite');
        tx.objectStore(store).delete(id).oncomplete = () => {
            if(store === 'sops') renderFiles('sops', 'list-sops');
            else renderFiles('assets', 'list-assets');
        };
    }
}

// --- UTILS ---
function saveLocal() {
    localStorage.setItem('db_'+activeUnit, JSON.stringify(db));
}

function exportJSON() {
    const str = JSON.stringify(db);
    const blob = new Blob([str], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `DATA_${activeUnit}.json`;
    document.body.appendChild(a);
    a.click();
}

function importJSON() {
    const file = document.getElementById('json-file').files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            db = JSON.parse(e.target.result);
            saveLocal();
            alert("Data berhasil dimuat!");
            location.reload();
        } catch(err) { alert("File rusak"); }
    };
    reader.readAsText(file);
}
</script>
</body>
</html>
