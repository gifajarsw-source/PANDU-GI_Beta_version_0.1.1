<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>PANDU-GI | Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. MODERN COLOR PALETTE (Sesuai Logo) --- */
        :root {
            /* Warna diambil dari Logo */
            --brand-dark: #0f172a;   /* Navy Gelap */
            --brand-teal: #0d9488;   /* Teal/Hijau Tosca Logo */
            --brand-gold: #fbbf24;   /* Aksen Gold/Kuning Logo */
            
            /* Warna UI */
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            
            /* Shadow Halus */
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            
            /* Status Colors */
            --danger: #ef4444; 
            --success: #10b981;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
        }

        /* --- 2. HEADER DESIGN (Sesuai Request) --- */
        .top-bar {
            background-color: var(--brand-dark);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .top-bar-title { font-weight: 700; font-size: 18px; letter-spacing: 0.5px; }
        
        /* Logo Circle di Kanan Atas */
        .header-logo-circle {
            width: 36px; height: 36px;
            background: white;
            border-radius: 50%;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--brand-gold);
        }
        .header-logo-circle img { width: 100%; height: 100%; object-fit: cover; }

        /* Sub-Header Putih */
        .sub-header {
            background: var(--surface);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        
        .brand-row { display: flex; align-items: center; gap: 8px; font-weight: 800; color: var(--brand-teal); font-size: 16px; }
        .unit-badge {
            background: #eff6ff; color: var(--brand-dark);
            font-size: 10px; font-weight: 700;
            padding: 4px 8px; border-radius: 6px;
            border: 1px solid #dbeafe;
            text-transform: uppercase;
        }

        .container { max-width: 500px; margin: 0 auto; padding: 20px; min-height: 85vh; }

        /* --- 3. DASHBOARD MENU (Sesuai Gambar) --- */
        .greeting-area { margin-bottom: 25px; }
        .greeting-title { font-size: 20px; font-weight: 700; color: var(--text-main); margin: 0; }
        .greeting-sub { font-size: 13px; color: var(--text-sub); margin-top: 4px; }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .menu-card {
            background: var(--surface);
            border-radius: 20px; /* Rounded besar sesuai gambar */
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow-card);
            border: 1px solid transparent;
            transition: transform 0.15s, border-color 0.15s;
            cursor: pointer;
            height: 160px; /* Tinggi seragam */
            justify-content: center;
        }
        
        .menu-card:active { transform: scale(0.97); border-color: var(--brand-teal); }

        /* Icon dengan Background Halus */
        .icon-box {
            width: 56px; height: 56px;
            border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 26px;
            margin-bottom: 16px;
        }
        
        .ic-blue { background: #eff6ff; color: #2563eb; }
        .ic-purple { background: #f5f3ff; color: #8b5cf6; }
        .ic-green { background: #ecfdf5; color: #10b981; }
        .ic-orange { background: #fff7ed; color: #f97316; }
        .ic-gray { background: #f8fafc; color: #475569; }

        .menu-name { font-weight: 700; font-size: 14px; color: var(--text-main); line-height: 1.2; }
        .menu-info { font-size: 11px; color: var(--text-sub); margin-top: 4px; }

        /* Menu Lebar (Full Width) */
        .menu-full {
            grid-column: span 2;
            flex-direction: row;
            justify-content: flex-start;
            padding: 20px;
            height: auto;
            text-align: left;
            gap: 16px;
        }
        .menu-full .icon-box { margin-bottom: 0; width: 48px; height: 48px; font-size: 22px; }

        /* --- 4. SECTION & FORM STYLES --- */
        .app-section { display: none; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .app-section.active { display: block; }

        /* Card List Data */
        .data-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
            border: 1px solid var(--border);
            position: relative;
        }
        .data-title { font-weight: 700; font-size: 15px; color: var(--text-main); margin-bottom: 5px; }
        .data-badge { 
            display: inline-block; padding: 3px 8px; border-radius: 6px; 
            background: #eff6ff; color: var(--brand-teal); 
            font-size: 10px; font-weight: 700; margin-bottom: 8px; 
        }
        .data-row { margin-top: 8px; }
        .lbl { font-size: 10px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
        .val { font-size: 13px; color: var(--text-main); white-space: pre-line; }

        /* Input & Button Modern */
        input, textarea, select {
            width: 100%; padding: 14px; border: 1px solid var(--border);
            border-radius: 12px; font-family: inherit; font-size: 14px;
            background: #fff; margin-bottom: 12px; transition: 0.2s;
        }
        input:focus, textarea:focus { border-color: var(--brand-teal); outline: none; }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-weight: 700; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 10px; transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { background: var(--brand-teal); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        
        .delete-btn {
            position: absolute; top: 15px; right: 15px;
            background: #fff1f2; color: #ef4444; border:none;
            width: 28px; height: 28px; border-radius: 8px;
            display:flex; align-items:center; justify-content:center;
            cursor: pointer;
        }

        /* --- 5. MODAL & PDF VIEWER --- */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: flex-end; justify-content: center; }
        .modal { background: var(--surface); width: 100%; max-width: 500px; border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        .modal.full { height: 95vh; padding: 0; display: flex; flex-direction: column; }
        
        .pdf-header { padding: 12px 20px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .pdf-frame { flex: 1; width: 100%; border: none; background: #eee; }

        /* Login Screen */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; padding: 20px; text-align: center; }
        .login-logo { width: 100px; height: 100px; margin-bottom: 20px; border-radius: 20px; box-shadow: var(--shadow-card); object-fit: contain; }
        .search-login-box { width: 100%; padding: 15px; border-radius: 30px; border: 1px solid var(--border); background: white; box-shadow: var(--shadow-card); text-align: center; }
        .unit-list { margin-top: 15px; width: 100%; background: white; border-radius: 16px; border: 1px solid var(--border); max-height: 300px; overflow-y: auto; display: none; text-align: left; }
        .unit-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 14px; font-weight: 500; }
        .unit-item:active { background: #f0fdfa; color: var(--brand-teal); }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Utils */
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 50px; font-size: 13px; z-index: 3000; display: none; }
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--brand-teal); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (min-width: 600px) { .overlay { align-items: center; padding: 20px; } .modal { border-radius: 20px; max-height: 85vh; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <img src="logo.jpeg" class="login-logo" onerror="this.style.display='none'" alt="Logo PANDU-GI">
        
        <h1 style="margin:0; color:var(--brand-dark); font-size:28px;">PANDU-GI</h1>
        <p style="margin:5px 0 30px 0; color:var(--text-sub);">Pusat Bantuan Digital Unit Gardu Induk</p>
        
        <input type="text" id="login-search" class="search-login-box" placeholder="üîç Pilih Gardu Induk..." readonly onclick="toggleUnitList()">
        
        <div id="unit-list" class="unit-list"></div>
        
        <button onclick="hardReset()" style="margin-top:40px; background:none; border:none; color:#cbd5e1; font-size:11px; cursor:pointer;">[ Reset Aplikasi ]</button>
    </div>

    <div id="app-header" style="display: none;">
        <div class="top-bar">
            <div class="top-bar-title">PANDU-GI</div>
            <div class="header-logo-circle">
                <img src="logo.jpeg" onerror="this.style.display='none'">
            </div>
        </div>
        
        <div class="sub-header">
            <div style="flex-grow:1; display:flex; align-items:center; gap:8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/></svg>
                <span class="brand-row">PANDU-GI</span>
                <span class="unit-badge" id="header-unit-name">...</span>
            </div>
            <button id="nav-back-btn" onclick="goHome()" style="display:none; background:#f1f5f9; border:none; padding:6px 12px; border-radius:20px; font-size:12px; font-weight:700; color:var(--text-sub); cursor:pointer;">&larr; Menu</button>
        </div>
    </div>

    <div class="container" id="app-container" style="display: none;">
        
        <div id="main-menu">
            <div class="greeting-area">
                <h2 class="greeting-title">Selamat Bertugas</h2>
                <div class="greeting-sub">Unit: <b id="dashboard-unit-name">...</b></div>
                <div style="font-size:11px; color:var(--brand-teal); margin-top:5px; cursor:pointer;" onclick="logout()">[ Ganti Lokasi ]</div>
            </div>

            <div class="menu-grid">
                <div class="menu-card" onclick="openSection('section-annunciator')">
                    <div class="icon-box ic-blue">üîî</div>
                    <div class="menu-name">Cari Alarm</div>
                    <div class="menu-info">Data Annunciator</div>
                </div>

                <div class="menu-card" onclick="openSection('section-asset')">
                    <div class="icon-box ic-purple">üñ•Ô∏è</div>
                    <div class="menu-name">Data Peralatan</div>
                    <div class="menu-info">Spesifikasi Asset</div>
                </div>

                <div class="menu-card" onclick="openSection('section-sop')">
                    <div class="icon-box ic-green">üìÑ</div>
                    <div class="menu-name">SOP</div>
                    <div class="menu-info">Manual Book PDF</div>
                </div>

                <div class="menu-card" onclick="openSection('section-contact')">
                    <div class="icon-box ic-orange">üìû</div>
                    <div class="menu-name">Kontak</div>
                    <div class="menu-info">Nomor Darurat</div>
                </div>

                <div class="menu-card menu-full" onclick="openSection('section-database')">
                    <div class="icon-box ic-gray">‚òÅÔ∏è</div>
                    <div class="menu-text">
                        <div class="menu-name">Akses Database</div>
                        <div class="menu-info">Google Drive & Backup</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-annunciator" class="app-section">
            <div style="position:sticky; top:0; background:var(--bg-body); padding-bottom:10px; z-index:10;">
                <input type="text" id="search-ann" placeholder="Cari nama alarm / indikasi..." oninput="renderAnnunciator()" style="box-shadow:var(--shadow-card); border-color:transparent;">
                <button class="btn btn-primary" onclick="openModal('modal-ann')">+ Input Alarm Baru</button>
            </div>
            <div id="list-ann"></div>
        </div>

        <div id="section-sop" class="app-section">
            <div class="data-card" style="border-top: 4px solid var(--success);">
                <div class="data-title">Simpan SOP Offline</div>
                <p style="font-size:12px; color:var(--text-sub); margin-bottom:10px;">Upload file PDF agar bisa dibaca saat tidak ada sinyal.</p>
                <input type="text" id="sop-name" placeholder="Judul SOP">
                <input type="file" id="sop-file" accept="application/pdf">
                <button class="btn btn-success" onclick="saveSOP()">Simpan ke Aplikasi</button>
            </div>
            <div style="font-size:11px; font-weight:700; color:var(--text-sub); margin-bottom:10px; letter-spacing:0.5px;">DAFTAR SOP TERSIMPAN</div>
            <div id="list-sop"></div>
        </div>

        <div id="section-asset" class="app-section">
            <div class="data-card" style="border-top: 4px solid var(--purple);">
                <div class="data-title">Simpan Data Peralatan</div>
                <p style="font-size:12px; color:var(--text-sub); margin-bottom:10px;">Upload Manual Book / Gambar Teknik (PDF).</p>
                <input type="text" id="asset-name" placeholder="Judul Dokumen">
                <input type="file" id="asset-file" accept="application/pdf">
                <button class="btn btn-primary" style="background:var(--purple);" onclick="saveAsset()">Simpan ke Aplikasi</button>
            </div>
            <div style="font-size:11px; font-weight:700; color:var(--text-sub); margin-bottom:10px; letter-spacing:0.5px;">FILE TERSIMPAN</div>
            <div id="list-asset"></div>
        </div>

        <div id="section-database" class="app-section">
            <div class="data-card" style="text-align:center; padding:30px 20px;">
                <div style="font-size:40px; margin-bottom:10px;">‚òÅÔ∏è</div>
                <h3 style="margin:0; font-size:18px;">Google Drive Utama</h3>
                <p style="font-size:12px; color:var(--text-sub); margin:5px 0 20px 0;">Pusat seluruh data online (SOP, Asset, Laporan).</p>
                <button class="btn btn-primary" onclick="openGDrive()">Buka Folder Drive ‚ÜóÔ∏è</button>
                
                <div style="margin-top:15px; padding-top:15px; border-top:1px dashed var(--border); text-align:left;">
                    <label class="lbl">Link Folder</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="in-gdrive-link" placeholder="Paste link..." style="margin:0">
                        <button class="btn btn-secondary" onclick="saveGDriveLink()" style="width:auto; margin:0">Set</button>
                    </div>
                </div>
            </div>

            <div class="data-card">
                <div class="data-title">Backup & Restore</div>
                <p style="font-size:12px; color:var(--text-sub); margin-bottom:15px;">Amankan data aplikasi (Alarm & Kontak) ke format JSON.</p>
                
                <button class="btn btn-secondary" onclick="exportData()">‚¨áÔ∏è Export Data JSON</button>
                
                <div style="margin-top:15px; padding-top:15px; border-top:1px dashed var(--border);">
                    <label class="lbl">Restore Data</label>
                    <input type="file" id="import-file" accept=".json">
                    <button class="btn btn-success" onclick="importData(document.getElementById('import-file'))">Restore JSON</button>
                </div>
            </div>

            <button class="btn btn-danger" onclick="resetApp()" style="margin-top:20px;">‚ö†Ô∏è Reset Data Unit Ini</button>
        </div>

        <div id="section-contact" class="app-section">
            <button class="btn btn-primary" onclick="openModal('modal-contact')">+ Tambah Kontak</button>
            <div id="list-contact" style="margin-top:15px;"></div>
        </div>

    </div>

    <div id="modal-ann" class="overlay">
        <div class="modal">
            <h3 style="margin-top:0">Form Alarm</h3>
            <input type="hidden" id="ann-id">
            <label class="lbl">Unit / Bay</label><input id="ann-unit">
            <label class="lbl">Nama Alarm</label><input id="ann-name">
            <label class="lbl">Indikasi</label><textarea id="ann-ind" rows="2"></textarea>
            <label class="lbl">Penyebab</label><textarea id="ann-cause" rows="2"></textarea>
            <label class="lbl">Tindakan</label><textarea id="ann-action" rows="2"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-primary" onclick="saveAnnItem()">Simpan</button>
                <button class="btn btn-secondary" onclick="closeModal('modal-ann')">Tutup</button>
            </div>
        </div>
    </div>

    <div id="modal-contact" class="overlay">
        <div class="modal">
            <h3 style="margin-top:0">Data Kontak</h3>
            <input type="hidden" id="contact-id">
            <label class="lbl">Nama</label><input id="contact-name">
            <label class="lbl">No. Telepon</label><input type="tel" id="contact-num">
            <button class="btn btn-primary" onclick="saveContactItem()">Simpan</button>
            <button class="btn btn-secondary" style="margin-top:10px" onclick="closeModal('modal-contact')">Batal</button>
        </div>
    </div>

    <div id="modal-pdf" class="overlay">
        <div class="modal full">
            <div class="pdf-header">
                <b id="pdf-title">Dokumen</b>
                <button onclick="closeModal('modal-pdf')" style="background:none; border:none; font-weight:700; color:var(--text-main);">Tutup ‚úï</button>
            </div>
            <iframe id="pdf-frame" class="pdf-frame"></iframe>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div><div>Memproses...</div></div>
    <div id="toast">Berhasil disimpan!</div>

<script>
// --- DATA AWAL ---
const UNITS = [
    { id: 'fajar', name: 'GI 150 KV FAJAR SURYAWISESA' },
    { id: 'gandamekar', name: 'GI 150 KV GANDAMEKAR' },
    { id: 'cikarang', name: 'GI 150 KV CIKARANG' },
    { id: 'jababeka', name: 'GI 150 KV JABABEKA' },
    { id: 'rajapaksi', name: 'GI 150 KV RAJAPAKSI' },
    { id: 'poncol', name: 'GI 150 KV PONCOL BARU' },
    { id: 'tambun', name: 'GI 150 KV TAMBUN' },
    { id: 'margahayu', name: 'GIS 150 KV MARGAHAYU' },
    { id: 'new_tambun_tet', name: 'GISTET 500 KV NEW TAMBUN' },
    { id: 'muaratawar', name: 'GITET 500 KV MUARATAWAR' },
    { id: 'new_tambun_gis', name: 'GIS 150 KV NEW TAMBUN' }
];

const MASTER_LINK = "https://drive.google.com/drive/folders/13vT0iXCJLjer9sMS5VWI5jjchFk4ntmo?usp=sharing";

// VARIABLES
let currentUnitId = null;
let db = { anns: [], contacts: [] };
let idb;
let driveLink = "";

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    initAppSequence();
});

function initAppSequence() {
    const savedId = localStorage.getItem('pandu_active_unit');
    if (savedId) {
        login(savedId);
    } else {
        showLoginScreen();
    }
}

// --- LOGIN SYSTEM ---
function showLoginScreen() {
    const list = document.getElementById('unit-list');
    list.innerHTML = '';
    UNITS.forEach(u => {
        const div = document.createElement('div');
        div.className = 'unit-item';
        div.innerText = u.name;
        div.onclick = () => login(u.id);
        list.appendChild(div);
    });
}

function toggleUnitList() {
    const list = document.getElementById('unit-list');
    list.style.display = list.style.display === 'block' ? 'none' : 'block';
}

function login(unitId) {
    const unit = UNITS.find(u => u.id === unitId);
    if (!unit) { hardReset(); return; }

    currentUnitId = unitId;
    localStorage.setItem('pandu_active_unit', unitId);

    // Load Data Text
    try {
        const saved = localStorage.getItem(`pandu_db_${unitId}`);
        if(saved) {
            let t = JSON.parse(saved);
            if(t.alarms) { // Migrasi format lama
                t.anns = t.alarms.map(x=>({id:x.id||Date.now(), unit:x.s, name:x.a, ind:x.m, cause:x.p, act:x.t}));
                delete t.alarms;
            }
            db = t;
            if(!db.anns) db.anns = [];
        } else {
            db = { anns: [], contacts: [] };
        }
    } catch(e) { db = { anns: [], contacts: [] }; }

    // Load Link
    driveLink = localStorage.getItem(`pandu_drive_${unitId}`) || MASTER_LINK;
    document.getElementById('in-gdrive-link').value = driveLink;

    // Init DB File
    initIndexedDB(unitId);

    // Update UI
    document.getElementById('header-unit-name').innerText = unit.name; // Di Header
    document.getElementById('dashboard-unit-name').innerText = unit.name; // Di Dashboard
    
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-header').style.display = 'block';
    document.getElementById('app-container').style.display = 'block';
    
    goHome();
}

function logout() {
    if(confirm('Ganti Unit Gardu Induk?')) {
        localStorage.removeItem('pandu_active_unit');
        location.reload();
    }
}

function hardReset() {
    if(confirm('Reset total aplikasi? Data akan hilang.')) {
        localStorage.clear();
        location.reload();
    }
}

// --- NAVIGATION ---
function goHome() {
    document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
    document.getElementById('main-menu').style.display = 'block';
    document.getElementById('nav-back-btn').style.display = 'none';
    window.scrollTo(0,0);
}

function openSection(id) {
    document.getElementById('main-menu').style.display = 'none';
    document.getElementById(id).classList.add('active');
    document.getElementById('nav-back-btn').style.display = 'block';
    
    if(id === 'section-annunciator') renderAnnunciator();
    if(id === 'section-contact') renderContact();
    if(id === 'section-sop') renderFiles('sops', 'list-sop');
    if(id === 'section-asset') renderFiles('assets', 'list-asset');
}

// --- DRIVE LINK ---
function saveGDriveLink() {
    const val = document.getElementById('in-gdrive-link').value;
    localStorage.setItem(`pandu_drive_${currentUnitId}`, val);
    driveLink = val; showToast("Link tersimpan");
}
function openGDrive() {
    if(driveLink) window.open(driveLink, '_blank');
    else window.open(MASTER_LINK, '_blank');
}

// --- INDEXED DB (FILE SYSTEM) ---
function initIndexedDB(uid) {
    const req = indexedDB.open(`PanduGI_${uid}`, 1);
    req.onupgradeneeded = e => {
        const d = e.target.result;
        if(!d.objectStoreNames.contains('sops')) d.createObjectStore('sops', {keyPath:'id', autoIncrement:true});
        if(!d.objectStoreNames.contains('assets')) d.createObjectStore('assets', {keyPath:'id', autoIncrement:true});
    };
    req.onsuccess = e => { idb = e.target.result; };
}

function saveFile(store, nameId, fileId) {
    const name = document.getElementById(nameId).value;
    const file = document.getElementById(fileId).files[0];
    if(!name || !file) return alert("Lengkapi Data!");
    
    document.getElementById('loader').style.display='flex';
    const reader = new FileReader();
    reader.onload = e => {
        const tx = idb.transaction(store, 'readwrite');
        tx.objectStore(store).add({
            name: name,
            blob: new Blob([e.target.result], {type: 'application/pdf'}),
            date: new Date().toLocaleDateString()
        });
        tx.oncomplete = () => {
            document.getElementById('loader').style.display='none';
            showToast("Berhasil Disimpan");
            document.getElementById(nameId).value = "";
            document.getElementById(fileId).value = "";
            renderFiles(store, store==='sops'?'list-sop':'list-asset');
        };
    };
    reader.readAsArrayBuffer(file);
}

function renderFiles(store, listId) {
    const list = document.getElementById(listId);
    list.innerHTML = "<div class='spinner' style='width:20px;height:20px;margin:10px auto'></div>";
    
    if(!idb) { setTimeout(() => renderFiles(store, listId), 500); return; }
    
    const tx = idb.transaction(store, 'readonly');
    tx.objectStore(store).getAll().onsuccess = e => {
        const res = e.target.result.reverse();
        list.innerHTML = "";
        if(res.length === 0) list.innerHTML = "<div class='empty-state'>Belum ada file.</div>";
        
        res.forEach(f => {
            list.innerHTML += `
            <div class="data-card" style="display:flex; justify-content:space-between; align-items:center; padding:12px;">
                <div style="overflow:hidden;">
                    <div style="font-weight:700; font-size:14px;">${f.name}</div>
                    <div style="font-size:11px; color:var(--text-sub);">${f.date}</div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-secondary" style="width:auto; padding:6px 10px;" onclick="openPdf('${store}',${f.id},'${f.name}')">Buka</button>
                    <button class="btn-danger" style="width:auto; padding:6px 10px;" onclick="delFile('${store}',${f.id})">üóëÔ∏è</button>
                </div>
            </div>`;
        });
    };
}

function openPdf(store, id, title) {
    document.getElementById('loader').style.display='flex';
    idb.transaction(store, 'readonly').objectStore(store).get(id).onsuccess = e => {
        document.getElementById('loader').style.display='none';
        if(e.target.result) {
            const url = URL.createObjectURL(e.target.result.blob);
            document.getElementById('pdf-title').innerText = title;
            document.getElementById('pdf-frame').src = url;
            document.getElementById('modal-pdf').style.display = 'flex';
        } else { alert("File error"); }
    };
}

function delFile(store, id) {
    if(confirm('Hapus?')) {
        const tx = idb.transaction(store, 'readwrite');
        tx.objectStore(store).delete(id).oncomplete = () => renderFiles(store, store==='sops'?'list-sop':'list-asset');
    }
}

// --- CRUD DATA ---
function saveDB() { localStorage.setItem(`pandu_db_${currentUnitId}`, JSON.stringify(db)); }

function renderAnnunciator() {
    const list = document.getElementById('list-ann');
    const key = document.getElementById('search-ann').value.toLowerCase();
    list.innerHTML = "";
    
    const f = db.anns.filter(x => (x.unit+x.name+x.ind+x.cause+x.act).toLowerCase().includes(key));
    if(f.length === 0) return list.innerHTML = "<div class='empty-state'>Tidak ditemukan.</div>";
    
    f.forEach(i => {
        list.innerHTML += `
        <div class="data-card">
            <button class="delete-btn" onclick="delAnn('${i.id}')">‚úï</button>
            <div class="data-badge">${i.unit}</div>
            <div class="data-title" onclick="editAnn('${i.id}')">${i.name}</div>
            <div class="lbl">Indikasi</div><div class="val">${i.ind}</div>
            <div class="lbl">Penyebab</div><div class="val">${i.cause}</div>
            <div class="lbl">Tindakan</div><div class="val">${i.act}</div>
        </div>`;
    });
}

function saveAnnItem() {
    const id = document.getElementById('ann-id').value || Date.now().toString();
    const item = {
        id: id,
        unit: document.getElementById('ann-unit').value,
        name: document.getElementById('ann-name').value,
        ind: document.getElementById('ann-ind').value,
        cause: document.getElementById('ann-cause').value,
        act: document.getElementById('ann-act').value
    };
    if(!item.name) return alert("Isi Nama Alarm");
    
    const idx = db.anns.findIndex(x=>x.id==id);
    if(idx > -1) db.anns[idx] = item; else db.anns.unshift(item);
    
    saveDB(); closeModal('modal-ann'); renderAnnunciator(); showToast("Tersimpan");
}

function editAnn(id) {
    const x = db.anns.find(i=>i.id==id);
    document.getElementById('ann-id').value = x.id;
    document.getElementById('ann-unit').value = x.unit;
    document.getElementById('ann-name').value = x.name;
    document.getElementById('ann-ind').value = x.ind;
    document.getElementById('ann-cause').value = x.cause;
    document.getElementById('ann-act').value = x.act;
    openModal('modal-ann');
}

function delAnn(id) {
    if(confirm('Hapus alarm ini?')) {
        db.anns = db.anns.filter(x => x.id != id);
        saveDB(); renderAnnunciator();
    }
}

function renderContact() {
    const list = document.getElementById('list-contact'); list.innerHTML = "";
    db.contacts.forEach(c => {
        list.innerHTML += `
        <div class="data-card" style="display:flex; justify-content:space-between; align-items:center;">
            <div><div class="data-title" style="margin:0">${c.name}</div><div style="color:var(--primary); font-weight:600;">${c.num}</div></div>
            <button class="delete-btn" style="position:static;" onclick="delCont('${c.id}')">‚úï</button>
        </div>`;
    });
}

function saveContactItem() {
    const item = { id: Date.now().toString(), name: document.getElementById('contact-name').value, num: document.getElementById('contact-num').value };
    if(!item.name) return;
    db.contacts.push(item); saveDB(); closeModal('modal-contact'); renderContact();
}

function delCont(id) {
    if(confirm('Hapus kontak?')) { db.contacts = db.contacts.filter(c => c.id != id); saveDB(); renderContact(); }
}

// WRAPPERS
function saveSOP() { saveFile('sops', 'sop-name', 'sop-file'); }
function saveAsset() { saveFile('assets', 'asset-name', 'asset-file'); }

function exportData() {
    const s = JSON.stringify(db);
    const b = new Blob([s], {type:"application/json"});
    const url = URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href = url;
    a.download = `BACKUP_${currentUnitId}.json`;
    document.body.appendChild(a); a.click(); a.remove();
}

function importData() {
    const f = document.getElementById('import-file').files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            const j = JSON.parse(e.target.result);
            if(confirm('Timpa data saat ini?')) {
                // Compatibility check
                if(j.alarms) { j.anns = j.alarms.map(x=>({id:x.id, unit:x.s, name:x.a, ind:x.m, cause:x.p, act:x.t})); delete j.alarms; }
                db = j; saveDB(); alert('Berhasil Restore!'); location.reload();
            }
        } catch(err) { alert('File rusak'); }
    };
    r.readAsText(f);
}

function resetApp() {
    if(confirm('Hapus SEMUA data unit ini?')) {
        localStorage.removeItem(`pandu_db_${currentUnitId}`);
        localStorage.removeItem(`pandu_drive_${currentUnitId}`);
        indexedDB.deleteDatabase(`PanduGI_${currentUnitId}`);
        location.reload();
    }
}

// UI HELPER
function openModal(id) { 
    document.getElementById(id).style.display='flex';
    if(id==='modal-ann') ['ann-id','ann-unit','ann-name','ann-ind','ann-cause','ann-act'].forEach(k=>document.getElementById(k).value='');
    if(id==='modal-contact') ['contact-id','contact-name','contact-num'].forEach(k=>document.getElementById(k).value='');
}
function closeModal(id) { document.getElementById(id).style.display='none'; }
function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }

</script>
</body>
</html>
