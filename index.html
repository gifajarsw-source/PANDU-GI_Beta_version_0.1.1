<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>PANDU-GI | Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. MODERN COLOR PALETTE --- */
        :root {
            --brand-dark: #0f172a;   /* Navy Gelap */
            --brand-teal: #0d9488;   /* Teal/Hijau Tosca */
            --brand-gold: #fbbf24;   /* Aksen Gold */
            
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #e2e8f0;
            
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            
            --danger: #ef4444; 
            --success: #10b981;
            --purple: #8b5cf6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 80px; /* Space for scroll */
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }

        /* --- 2. HEADER DESIGN --- */
        .top-bar {
            background-color: var(--brand-dark);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .top-bar-title { font-weight: 700; font-size: 18px; letter-spacing: 0.5px; }
        
        .header-logo-circle {
            width: 36px; height: 36px;
            background: white;
            border-radius: 50%;
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--brand-gold);
            font-size: 10px; color: var(--brand-dark); font-weight: bold;
        }
        .header-logo-circle img { width: 100%; height: 100%; object-fit: cover; }

        .sub-header {
            background: var(--surface);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: sticky;
            top: 66px; /* Adjust based on top-bar height */
            z-index: 99;
        }
        
        .brand-row { display: flex; align-items: center; gap: 8px; font-weight: 800; color: var(--brand-teal); font-size: 15px; }
        .unit-badge {
            background: #eff6ff; color: var(--brand-dark);
            font-size: 10px; font-weight: 700;
            padding: 4px 8px; border-radius: 6px;
            border: 1px solid #dbeafe;
            text-transform: uppercase;
            max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; min-height: 85vh; }

        /* --- 3. DASHBOARD MENU --- */
        .greeting-area { margin-bottom: 25px; }
        .greeting-title { font-size: 22px; font-weight: 700; color: var(--text-main); margin: 0; }
        .greeting-sub { font-size: 13px; color: var(--text-sub); margin-top: 4px; }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .menu-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow-card);
            border: 1px solid transparent;
            transition: transform 0.15s, border-color 0.15s;
            cursor: pointer;
            min-height: 150px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        /* Touch feedback */
        .menu-card:active { transform: scale(0.96); background: #f8fafc; }

        .icon-box {
            width: 52px; height: 52px;
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            margin-bottom: 14px;
        }
        
        .ic-blue { background: #eff6ff; color: #2563eb; }
        .ic-purple { background: #f5f3ff; color: #8b5cf6; }
        .ic-green { background: #ecfdf5; color: #10b981; }
        .ic-orange { background: #fff7ed; color: #f97316; }
        .ic-gray { background: #f8fafc; color: #475569; }

        .menu-name { font-weight: 700; font-size: 14px; color: var(--text-main); line-height: 1.2; }
        .menu-info { font-size: 11px; color: var(--text-sub); margin-top: 4px; }

        .menu-full {
            grid-column: span 2;
            flex-direction: row;
            justify-content: flex-start;
            padding: 20px;
            min-height: auto;
            text-align: left;
            gap: 16px;
        }
        .menu-full .icon-box { margin-bottom: 0; width: 44px; height: 44px; font-size: 20px; }

        /* --- 4. SECTION & FORM STYLES --- */
        .app-section { display: none; animation: fadeIn 0.3s ease; }
        .app-section.active { display: block; }

        .data-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            position: relative;
        }
        .data-title { font-weight: 700; font-size: 15px; color: var(--text-main); margin-bottom: 5px; line-height: 1.4; }
        .data-badge { 
            display: inline-block; padding: 3px 8px; border-radius: 6px; 
            background: #eff6ff; color: var(--brand-teal); 
            font-size: 10px; font-weight: 700; margin-bottom: 8px; 
        }
        .lbl { font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-top: 10px; display: block; }
        .val { font-size: 13px; color: var(--text-main); white-space: pre-line; line-height: 1.5; }

        /* Inputs */
        input, textarea, select {
            width: 100%; padding: 12px 14px; border: 1px solid var(--border);
            border-radius: 12px; font-family: inherit; font-size: 14px;
            background: #fff; margin-bottom: 12px; transition: 0.2s;
            -webkit-appearance: none; /* Remove iOS styles */
        }
        input:focus, textarea:focus { border-color: var(--brand-teal); outline: none; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-weight: 700; font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 10px; transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { background: var(--brand-teal); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        
        .delete-btn {
            position: absolute; top: 12px; right: 12px;
            background: #fff1f2; color: #ef4444; border:none;
            width: 32px; height: 32px; border-radius: 8px;
            display:flex; align-items:center; justify-content:center;
            cursor: pointer; font-size: 16px;
        }

        /* --- 5. MODAL & PDF --- */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(2px); z-index: 1000; display: none; align-items: flex-end; justify-content: center; }
        .modal { background: var(--surface); width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal.full { height: 100vh; max-height: 100vh; border-radius: 0; padding: 0; display: flex; flex-direction: column; }
        
        .pdf-header { padding: 10px 15px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; height: 50px; }
        .pdf-frame { flex: 1; width: 100%; height: 100%; border: none; background: #f1f5f9; display: block; }

        /* Login Screen */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; text-align: center; background: white; }
        .login-logo { width: 90px; height: 90px; margin-bottom: 20px; border-radius: 20px; object-fit: contain; }
        .search-login-box { padding: 16px; border-radius: 16px; border: 1px solid var(--border); background: #f8fafc; box-shadow: var(--shadow-card); text-align: center; font-size: 16px; font-weight: 500; }
        .unit-list { margin-top: 15px; width: 100%; background: white; border-radius: 16px; border: 1px solid var(--border); max-height: 40vh; overflow-y: auto; display: none; text-align: left; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .unit-item { padding: 16px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 14px; font-weight: 600; color: var(--brand-dark); }
        .unit-item:active { background: #f0fdfa; color: var(--brand-teal); }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Utils */
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 600; z-index: 3000; display: none; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); width: max-content; }
        #loader { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--brand-teal); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (min-width: 600px) { 
            .overlay { align-items: center; padding: 20px; } 
            .modal { border-radius: 20px; max-height: 85vh; } 
            .menu-card { min-height: 160px; }
        }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-sub); font-size: 14px; font-style: italic; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div style="font-weight: 900; font-size: 40px; color: var(--brand-teal); margin-bottom: 10px; letter-spacing: -1px;">PG</div>
        <h1 style="margin:0; color:var(--brand-dark); font-size:24px; font-weight: 800;">PANDU-GI</h1>
        <p style="margin:5px 0 30px 0; color:var(--text-sub); font-size: 14px;">Asisten Digital Operator Gardu Induk</p>
        
        <div style="width: 100%; max-width: 320px; position: relative;">
            <input type="text" id="login-search" class="search-login-box" placeholder="üîç Pilih Lokasi Unit..." readonly onclick="toggleUnitList()">
            <div id="unit-list" class="unit-list"></div>
        </div>
        
        <div style="margin-top: auto; padding-top: 20px;">
            <button onclick="hardReset()" style="background:none; border:none; color:#cbd5e1; font-size:11px; cursor:pointer; text-decoration: underline;">Reset Aplikasi (Clear Cache)</button>
        </div>
    </div>

    <div id="app-wrapper" style="display: none;">
        <div class="top-bar">
            <div class="top-bar-title">PANDU-GI</div>
            <div class="header-logo-circle">PRO</div>
        </div>
        
        <div class="sub-header">
            <div style="flex-grow:1; display:flex; align-items:center; gap:8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
                <span class="brand-row">Unit:</span>
                <span class="unit-badge" id="header-unit-name">...</span>
            </div>
            <button id="nav-back-btn" onclick="handleBack()" style="display:none; background:#f1f5f9; border:none; padding:8px 16px; border-radius:20px; font-size:12px; font-weight:700; color:var(--text-main); cursor:pointer;">&larr; Menu</button>
        </div>

        <div class="container">
            
            <div id="main-menu" class="app-section active">
                <div class="greeting-area">
                    <h2 class="greeting-title">Selamat Bertugas</h2>
                    <div class="greeting-sub">Lokasi: <b id="dashboard-unit-name">...</b></div>
                    <div style="font-size:12px; color:var(--brand-teal); margin-top:8px; display: inline-block; font-weight: 600; cursor: pointer;" onclick="logout()">[ üîÑ Ganti Lokasi ]</div>
                </div>

                <div class="menu-grid">
                    <div class="menu-card" onclick="navigateTo('section-annunciator')">
                        <div class="icon-box ic-blue">üîî</div>
                        <div class="menu-name">Cari Alarm</div>
                        <div class="menu-info">Kamus Annunciator</div>
                    </div>

                    <div class="menu-card" onclick="navigateTo('section-asset')">
                        <div class="icon-box ic-purple">‚ö°</div>
                        <div class="menu-name">Data Asset</div>
                        <div class="menu-info">Manual Book & Spec</div>
                    </div>

                    <div class="menu-card" onclick="navigateTo('section-sop')">
                        <div class="icon-box ic-green">üìë</div>
                        <div class="menu-name">SOP</div>
                        <div class="menu-info">Dokumen Instruksi</div>
                    </div>

                    <div class="menu-card" onclick="navigateTo('section-contact')">
                        <div class="icon-box ic-orange">‚òéÔ∏è</div>
                        <div class="menu-name">Kontak</div>
                        <div class="menu-info">Emergency Call</div>
                    </div>

                    <div class="menu-card menu-full" onclick="navigateTo('section-database')">
                        <div class="icon-box ic-gray">‚òÅÔ∏è</div>
                        <div class="menu-text">
                            <div class="menu-name">Database & Backup</div>
                            <div class="menu-info">Google Drive & JSON Export</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-annunciator" class="app-section">
                <div style="position:sticky; top:130px; background:var(--bg-body); padding-bottom:15px; z-index:10; margin-top: -10px;">
                    <div style="background: var(--surface); padding: 10px; border-radius: 12px; border: 1px solid var(--border); display: flex; gap: 8px;">
                        <input type="text" id="search-ann" placeholder="Ketik nama alarm..." oninput="debounceSearch()" style="margin:0; border:none; box-shadow:none; padding: 0 5px;">
                    </div>
                    <button class="btn btn-primary" style="margin-top: 10px; margin-bottom: 0;" onclick="openModal('modal-ann')">+ Tambah Data Alarm</button>
                </div>
                <div id="list-ann" style="padding-bottom: 40px;"></div>
            </div>

            <div id="section-sop" class="app-section">
                <div class="data-card" style="border-left: 4px solid var(--success);">
                    <div class="data-title">Upload SOP Baru (PDF)</div>
                    <p style="font-size:12px; color:var(--text-sub); margin-bottom:10px;">File tersimpan di memori browser (Offline Mode).</p>
                    <input type="text" id="sop-name" placeholder="Judul SOP...">
                    <input type="file" id="sop-file" accept="application/pdf">
                    <button class="btn btn-success" onclick="saveSOP()">Simpan ke Aplikasi</button>
                </div>
                <div style="font-size:12px; font-weight:800; color:var(--text-sub); margin: 20px 0 10px; letter-spacing:0.5px;">ARSIP OFFLINE</div>
                <div id="list-sop"></div>
            </div>

            <div id="section-asset" class="app-section">
                <div class="data-card" style="border-left: 4px solid var(--purple);">
                    <div class="data-title">Upload Data Asset (PDF)</div>
                    <p style="font-size:12px; color:var(--text-sub); margin-bottom:10px;">Simpan wiring diagram atau manual book.</p>
                    <input type="text" id="asset-name" placeholder="Nama Asset...">
                    <input type="file" id="asset-file" accept="application/pdf">
                    <button class="btn btn-primary" style="background:var(--purple);" onclick="saveAsset()">Simpan</button>
                </div>
                <div style="font-size:12px; font-weight:800; color:var(--text-sub); margin: 20px 0 10px; letter-spacing:0.5px;">FILE TERSIMPAN</div>
                <div id="list-asset"></div>
            </div>

            <div id="section-database" class="app-section">
                <div class="data-card" style="text-align:center; padding:30px 20px;">
                    <div style="font-size:40px; margin-bottom:10px;">üìÅ</div>
                    <h3 style="margin:0; font-size:18px;">Google Drive Unit</h3>
                    <p style="font-size:12px; color:var(--text-sub); margin:5px 0 20px 0;">Akses folder awan utama unit ini.</p>
                    <button class="btn btn-primary" onclick="openGDrive()">Buka Google Drive ‚ÜóÔ∏è</button>
                    
                    <div style="margin-top:20px; text-align:left;">
                        <label class="lbl">Set Link Drive (Khusus Admin)</label>
                        <div style="display:flex; gap:8px;">
                            <input type="text" id="in-gdrive-link" placeholder="https://drive.google.com/..." style="margin:0">
                            <button class="btn btn-secondary" onclick="saveGDriveLink()" style="width:auto; margin:0">Simpan</button>
                        </div>
                    </div>
                </div>

                <div class="data-card">
                    <div class="data-title">Backup & Restore Lokal</div>
                    <p style="font-size:12px; color:var(--text-sub); margin-bottom:15px;">Pindahkan data antar HP menggunakan file JSON.</p>
                    
                    <button class="btn btn-secondary" onclick="exportData()">‚¨áÔ∏è Download Backup (JSON)</button>
                    
                    <div style="margin-top:15px; padding-top:15px; border-top:1px dashed var(--border);">
                        <label class="lbl">Restore dari File</label>
                        <input type="file" id="import-file" accept=".json">
                        <button class="btn btn-success" onclick="executeImport()">Upload & Restore</button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="resetApp()" style="background:none; border:none; color:var(--danger); font-weight:700; font-size:12px; cursor:pointer;">‚ö†Ô∏è HAPUS SEMUA DATA UNIT INI</button>
                </div>
            </div>

            <div id="section-contact" class="app-section">
                <button class="btn btn-primary" onclick="openModal('modal-contact')">+ Tambah Kontak Baru</button>
                <div id="list-contact" style="margin-top:15px;"></div>
            </div>

        </div>
    </div>

    <div id="modal-ann" class="overlay">
        <div class="modal">
            <h3 style="margin-top:0">Form Alarm</h3>
            <input type="hidden" id="ann-id">
            
            <label class="lbl">Unit / Bay / Panel</label>
            <input id="ann-unit" placeholder="Cth: Bay Penghantar 1">
            
            <label class="lbl">Nama Alarm (Sesuai Display)</label>
            <input id="ann-name" placeholder="Cth: DISTANCE PROT TRIP">
            
            <label class="lbl">Indikasi (Lampu/Bendera)</label>
            <textarea id="ann-ind" rows="2"></textarea>
            
            <label class="lbl">Penyebab Kemungkinan</label>
            <textarea id="ann-cause" rows="2"></textarea>
            
            <label class="lbl">Tindakan / Penanganan</label>
            <textarea id="ann-action" rows="3"></textarea> <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn btn-secondary" onclick="closeModal('modal-ann')">Batal</button>
                <button class="btn btn-primary" onclick="saveAnnItem()">SIMPAN</button>
            </div>
        </div>
    </div>

    <div id="modal-contact" class="overlay">
        <div class="modal">
            <h3 style="margin-top:0">Data Kontak</h3>
            <input type="hidden" id="contact-id">
            <label class="lbl">Nama Pejabat / Instansi</label><input id="contact-name">
            <label class="lbl">No. Telepon / WA</label><input type="tel" id="contact-num">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn btn-secondary" onclick="closeModal('modal-contact')">Batal</button>
                <button class="btn btn-primary" onclick="saveContactItem()">SIMPAN</button>
            </div>
        </div>
    </div>

    <div id="modal-pdf" class="overlay" style="z-index: 5000;">
        <div class="modal full">
            <div class="pdf-header">
                <div id="pdf-title" style="font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80%;">Dokumen</div>
                <button onclick="closeModal('modal-pdf')" style="background:#f1f5f9; border:none; padding:8px 12px; border-radius:8px; font-weight:700; color:var(--text-main); font-size:12px;">TUTUP</button>
            </div>
            <iframe id="pdf-frame" class="pdf-frame"></iframe>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div><div style="font-weight:600; font-size:14px;">Memproses Data...</div></div>
    <div id="toast">Berhasil disimpan!</div>

<script>
// --- KONFIGURASI UNIT ---
const UNITS = [
    { id: 'fajar', name: 'GI 150 KV FAJAR SURYAWISESA' },
    { id: 'gandamekar', name: 'GI 150 KV GANDAMEKAR' },
    { id: 'cikarang', name: 'GI 150 KV CIKARANG' },
    { id: 'jababeka', name: 'GI 150 KV JABABEKA' },
    { id: 'rajapaksi', name: 'GI 150 KV RAJAPAKSI' },
    { id: 'poncol', name: 'GI 150 KV PONCOL BARU' },
    { id: 'tambun', name: 'GI 150 KV TAMBUN' },
    { id: 'margahayu', name: 'GIS 150 KV MARGAHAYU' },
    { id: 'new_tambun_tet', name: 'GISTET 500 KV NEW TAMBUN' },
    { id: 'muaratawar', name: 'GITET 500 KV MUARATAWAR' },
    { id: 'new_tambun_gis', name: 'GIS 150 KV NEW TAMBUN' }
];

const MASTER_LINK = "https://drive.google.com/drive/folders/13vT0iXCJLjer9sMS5VWI5jjchFk4ntmo?usp=sharing";

// GLOBAL STATE
let currentUnitId = null;
let db = { anns: [], contacts: [] };
let idb;
let driveLink = "";
let searchTimeout;

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    initAppSequence();
    
    // Handle Hardware Back Button Android
    window.addEventListener('popstate', (event) => {
        if (document.getElementById('main-menu').style.display === 'none') {
            goHome(false); // False means don't push state again
        }
    });
});

function initAppSequence() {
    const savedId = localStorage.getItem('pandu_active_unit');
    if (savedId) {
        login(savedId);
    } else {
        showLoginScreen();
    }
}

// --- LOGIN SYSTEM ---
function showLoginScreen() {
    const list = document.getElementById('unit-list');
    list.innerHTML = '';
    UNITS.forEach(u => {
        const div = document.createElement('div');
        div.className = 'unit-item';
        div.innerText = u.name;
        div.onclick = () => login(u.id);
        list.appendChild(div);
    });
}

function toggleUnitList() {
    const list = document.getElementById('unit-list');
    list.style.display = list.style.display === 'block' ? 'none' : 'block';
}

function login(unitId) {
    const unit = UNITS.find(u => u.id === unitId);
    if (!unit) { hardReset(); return; }

    currentUnitId = unitId;
    localStorage.setItem('pandu_active_unit', unitId);

    // Load Text Data (LocalStorage)
    try {
        const saved = localStorage.getItem(`pandu_db_${unitId}`);
        if(saved) {
            let t = JSON.parse(saved);
            // Migrasi format lama jika ada
            if(t.alarms) {
                t.anns = t.alarms.map(x=>({id:x.id||Date.now(), unit:x.s, name:x.a, ind:x.m, cause:x.p, act:x.t}));
                delete t.alarms;
            }
            db = t;
            if(!db.anns) db.anns = [];
            if(!db.contacts) db.contacts = [];
        } else {
            db = { anns: [], contacts: [] };
        }
    } catch(e) { db = { anns: [], contacts: [] }; }

    // Load Link
    driveLink = localStorage.getItem(`pandu_drive_${unitId}`) || MASTER_LINK;
    document.getElementById('in-gdrive-link').value = driveLink;

    // Init DB File (IndexedDB)
    initIndexedDB(unitId);

    // Update UI
    document.getElementById('header-unit-name').innerText = unit.name.replace('GI 150 KV ', '').replace('GIS 150 KV ', '');
    document.getElementById('dashboard-unit-name').innerText = unit.name;
    
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-wrapper').style.display = 'block';
    
    goHome(true);
}

function logout() {
    if(confirm('Keluar dari unit ini?')) {
        localStorage.removeItem('pandu_active_unit');
        location.reload();
    }
}

function hardReset() {
    if(confirm('PERINGATAN: Reset akan menghapus seluruh data yang tersimpan di browser ini. Lanjutkan?')) {
        localStorage.clear();
        indexedDB.databases().then(dbs => {
            dbs.forEach(db => indexedDB.deleteDatabase(db.name));
        });
        setTimeout(() => location.reload(), 500);
    }
}

// --- NAVIGATION MANAGER ---
function goHome(pushHistory = true) {
    document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
    document.getElementById('main-menu').classList.add('active');
    document.getElementById('main-menu').style.display = 'block';
    document.getElementById('nav-back-btn').style.display = 'none';
    
    // Clear search bar
    document.getElementById('search-ann').value = '';
    
    window.scrollTo(0,0);
    if(pushHistory) history.replaceState(null, null, location.pathname);
}

function navigateTo(sectionId) {
    document.getElementById('main-menu').style.display = 'none';
    document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
    
    const target = document.getElementById(sectionId);
    target.classList.add('active');
    document.getElementById('nav-back-btn').style.display = 'block';
    
    // Push history state to enable Back button functionality
    history.pushState({ section: sectionId }, "", "#" + sectionId);

    // Init Section Data
    if(sectionId === 'section-annunciator') renderAnnunciator();
    if(sectionId === 'section-contact') renderContact();
    if(sectionId === 'section-sop') renderFiles('sops', 'list-sop');
    if(sectionId === 'section-asset') renderFiles('assets', 'list-asset');
    
    window.scrollTo(0,0);
}

function handleBack() {
    // Trigger browser back behavior which calls popstate
    history.back();
}

// --- DRIVE LINK ---
function saveGDriveLink() {
    const val = document.getElementById('in-gdrive-link').value;
    localStorage.setItem(`pandu_drive_${currentUnitId}`, val);
    driveLink = val; showToast("Link tersimpan");
}
function openGDrive() {
    window.open(driveLink || MASTER_LINK, '_blank');
}

// --- INDEXED DB (FILE SYSTEM) ---
function initIndexedDB(uid) {
    const req = indexedDB.open(`PanduGI_${uid}`, 1);
    req.onupgradeneeded = e => {
        const d = e.target.result;
        if(!d.objectStoreNames.contains('sops')) d.createObjectStore('sops', {keyPath:'id', autoIncrement:true});
        if(!d.objectStoreNames.contains('assets')) d.createObjectStore('assets', {keyPath:'id', autoIncrement:true});
    };
    req.onsuccess = e => { idb = e.target.result; };
}

function saveFile(store, nameId, fileId) {
    const name = document.getElementById(nameId).value;
    const file = document.getElementById(fileId).files[0];
    if(!name || !file) return alert("Mohon lengkapi judul dan pilih file PDF.");
    
    // Limit file size (e.g. 10MB) to prevent crash
    if(file.size > 10 * 1024 * 1024) return alert("File terlalu besar (Maks 10MB)");

    document.getElementById('loader').style.display='flex';
    const reader = new FileReader();
    reader.onload = e => {
        const tx = idb.transaction(store, 'readwrite');
        tx.objectStore(store).add({
            name: name,
            blob: new Blob([e.target.result], {type: 'application/pdf'}),
            date: new Date().toLocaleDateString('id-ID')
        });
        tx.oncomplete = () => {
            document.getElementById('loader').style.display='none';
            showToast("File Berhasil Disimpan");
            document.getElementById(nameId).value = "";
            document.getElementById(fileId).value = "";
            renderFiles(store, store==='sops'?'list-sop':'list-asset');
        };
        tx.onerror = () => {
            document.getElementById('loader').style.display='none';
            alert("Gagal menyimpan. Memori penuh?");
        }
    };
    reader.readAsArrayBuffer(file);
}

function renderFiles(store, listId) {
    const list = document.getElementById(listId);
    list.innerHTML = "<div class='spinner' style='width:25px;height:25px;margin:10px auto'></div>";
    
    if(!idb) { setTimeout(() => renderFiles(store, listId), 500); return; }
    
    const tx = idb.transaction(store, 'readonly');
    tx.objectStore(store).getAll().onsuccess = e => {
        const res = e.target.result.reverse();
        list.innerHTML = "";
        if(res.length === 0) {
            list.innerHTML = "<div class='empty-state'>Belum ada dokumen tersimpan.</div>";
            return;
        }
        
        let html = '';
        res.forEach(f => {
            html += `
            <div class="data-card" style="display:flex; justify-content:space-between; align-items:center; padding:12px;">
                <div style="overflow:hidden; flex:1; margin-right:10px;">
                    <div style="font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${f.name}</div>
                    <div style="font-size:11px; color:var(--text-sub);">Diupload: ${f.date}</div>
                </div>
                <div style="display:flex; gap:8px; flex-shrink:0;">
                    <button class="btn-secondary" style="width:auto; padding:6px 12px; margin:0; font-size:12px;" onclick="openPdf('${store}',${f.id},'${f.name.replace(/'/g, "\\'")}')">Buka</button>
                    <button class="btn-danger" style="width:auto; padding:6px 10px; margin:0;" onclick="delFile('${store}',${f.id})">üóëÔ∏è</button>
                </div>
            </div>`;
        });
        list.innerHTML = html;
    };
}

function openPdf(store, id, title) {
    document.getElementById('loader').style.display='flex';
    idb.transaction(store, 'readonly').objectStore(store).get(id).onsuccess = e => {
        document.getElementById('loader').style.display='none';
        if(e.target.result) {
            const url = URL.createObjectURL(e.target.result.blob);
            document.getElementById('pdf-title').innerText = title;
            document.getElementById('pdf-frame').src = url;
            document.getElementById('modal-pdf').style.display = 'flex';
        } else { alert("File korup atau tidak ditemukan."); }
    };
}

function delFile(store, id) {
    if(confirm('Hapus file ini permanen?')) {
        const tx = idb.transaction(store, 'readwrite');
        tx.objectStore(store).delete(id).oncomplete = () => renderFiles(store, store==='sops'?'list-sop':'list-asset');
    }
}

// --- CRUD DATA (TEXT) ---
function saveDB() { localStorage.setItem(`pandu_db_${currentUnitId}`, JSON.stringify(db)); }

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(renderAnnunciator, 300);
}

function renderAnnunciator() {
    const list = document.getElementById('list-ann');
    const rawKey = document.getElementById('search-ann').value.toLowerCase();
    const keyParts = rawKey.split(' ').filter(k => k.trim() !== ''); // Support multi-keyword search
    
    // Safety check if db.anns is undefined
    if(!db.anns) db.anns = [];
    
    // Optimization: Render empty string first
    list.innerHTML = "";
    
    const filtered = db.anns.filter(x => {
        // Safe access to properties
        const text = ((x.unit||'') + ' ' + (x.name||'') + ' ' + (x.ind||'') + ' ' + (x.cause||'') + ' ' + (x.act||'')).toLowerCase();
        // Check if ALL keywords exist in the text
        return keyParts.every(part => text.includes(part));
    });

    if(filtered.length === 0) {
        list.innerHTML = rawKey ? "<div class='empty-state'>Tidak ditemukan hasil pencarian.</div>" : "<div class='empty-state'>Ketik nama alarm di kolom pencarian.</div>";
        return;
    }
    
    // Limit render to 50 items for performance
    const renderLimit = 50;
    const itemsToRender = filtered.slice(0, renderLimit);
    
    let htmlContent = "";
    itemsToRender.forEach(i => {
        // Escaping strings to prevent HTML breaking
        const safeName = (i.name || '').replace(/"/g, '&quot;');
        
        htmlContent += `
        <div class="data-card">
            <button class="delete-btn" onclick="delAnn('${i.id}')">‚úï</button>
            <div class="data-badge">${i.unit || '-'}</div>
            <div class="data-title" style="cursor:pointer; color:var(--brand-teal);" onclick="editAnn('${i.id}')">üìù ${i.name}</div>
            <div class="lbl">Indikasi</div><div class="val">${i.ind || '-'}</div>
            <div class="lbl">Penyebab</div><div class="val">${i.cause || '-'}</div>
            <div class="lbl">Tindakan</div><div class="val" style="font-weight:600; color:var(--brand-dark);">${i.act || '-'}</div>
        </div>`;
    });
    
    if(filtered.length > renderLimit) {
        htmlContent += `<div style="text-align:center; padding:10px; font-size:12px; color:var(--text-sub);">Menampilkan 50 dari ${filtered.length} hasil. Perspesifik pencarian.</div>`;
    }

    list.innerHTML = htmlContent;
}

function saveAnnItem() {
    const id = document.getElementById('ann-id').value || Date.now().toString();
    
    // CRITICAL FIX: ID for action was 'ann-act' in JS but 'ann-action' in HTML
    const item = {
        id: id,
        unit: document.getElementById('ann-unit').value,
        name: document.getElementById('ann-name').value,
        ind: document.getElementById('ann-ind').value,
        cause: document.getElementById('ann-cause').value,
        act: document.getElementById('ann-action').value 
    };

    if(!item.name) return alert("Nama Alarm wajib diisi!");
    
    const idx = db.anns.findIndex(x => x.id == id);
    if(idx > -1) db.anns[idx] = item; else db.anns.unshift(item);
    
    saveDB(); 
    closeModal('modal-ann'); 
    renderAnnunciator(); 
    showToast("Alarm Tersimpan");
}

function editAnn(id) {
    const x = db.anns.find(i => i.id == id);
    if(!x) return;
    document.getElementById('ann-id').value = x.id;
    document.getElementById('ann-unit').value = x.unit || '';
    document.getElementById('ann-name').value = x.name || '';
    document.getElementById('ann-ind').value = x.ind || '';
    document.getElementById('ann-cause').value = x.cause || '';
    document.getElementById('ann-action').value = x.act || ''; // Use x.act as per Data Structure
    openModal('modal-ann');
}

function delAnn(id) {
    if(confirm('Hapus alarm ini dari database?')) {
        db.anns = db.anns.filter(x => x.id != id);
        saveDB(); 
        renderAnnunciator();
    }
}

function renderContact() {
    const list = document.getElementById('list-contact'); 
    list.innerHTML = "";
    if(!db.contacts || db.contacts.length === 0) return list.innerHTML = "<div class='empty-state'>Belum ada kontak.</div>";

    db.contacts.forEach(c => {
        list.innerHTML += `
        <div class="data-card" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div class="data-title" style="margin:0">${c.name}</div>
                <a href="tel:${c.num}" style="color:var(--brand-teal); font-weight:700; text-decoration:none; font-size:14px; display:block; margin-top:4px;">üìû ${c.num}</a>
            </div>
            <button class="delete-btn" style="position:static;" onclick="delCont('${c.id}')">‚úï</button>
        </div>`;
    });
}

function saveContactItem() {
    const item = { 
        id: Date.now().toString(), 
        name: document.getElementById('contact-name').value, 
        num: document.getElementById('contact-num').value 
    };
    if(!item.name) return;
    db.contacts.push(item); saveDB(); closeModal('modal-contact'); renderContact();
}

function delCont(id) {
    if(confirm('Hapus kontak?')) { db.contacts = db.contacts.filter(c => c.id != id); saveDB(); renderContact(); }
}

// WRAPPERS
function saveSOP() { saveFile('sops', 'sop-name', 'sop-file'); }
function saveAsset() { saveFile('assets', 'asset-name', 'asset-file'); }

function exportData() {
    const s = JSON.stringify(db, null, 2);
    const b = new Blob([s], {type:"application/json"});
    const url = URL.createObjectURL(b);
    const a = document.createElement('a');
    a.href = url;
    a.download = `BACKUP_${currentUnitId}_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a); a.click(); a.remove();
}

function executeImport() {
    const f = document.getElementById('import-file').files[0];
    if(!f) return alert("Pilih file JSON dulu!");
    
    const r = new FileReader();
    r.onload = e => {
        try {
            const j = JSON.parse(e.target.result);
            if(confirm(`Ditemukan ${j.anns ? j.anns.length : 0} alarm. Timpa data saat ini?`)) {
                // Compatibility check
                if(j.alarms) { j.anns = j.alarms.map(x=>({id:x.id, unit:x.s, name:x.a, ind:x.m, cause:x.p, act:x.t})); delete j.alarms; }
                db = j; 
                saveDB(); 
                alert('Restore Sukses!'); 
                location.reload();
            }
        } catch(err) { alert('Format file salah atau rusak.'); }
    };
    r.readAsText(f);
}

function resetApp() {
    if(confirm('BAHAYA: Apakah anda yakin menghapus SEMUA data di Unit ini? Data tidak bisa dikembalikan.')) {
        localStorage.removeItem(`pandu_db_${currentUnitId}`);
        localStorage.removeItem(`pandu_drive_${currentUnitId}`);
        indexedDB.deleteDatabase(`PanduGI_${currentUnitId}`);
        location.reload();
    }
}

// UI HELPER
function openModal(id) { 
    document.getElementById(id).style.display='flex';
    // Clear inputs based on ID
    if(id==='modal-ann') ['ann-id','ann-unit','ann-name','ann-ind','ann-cause','ann-action'].forEach(k=> {
        if(document.getElementById(k)) document.getElementById(k).value='';
    });
    if(id==='modal-contact') ['contact-id','contact-name','contact-num'].forEach(k=>document.getElementById(k).value='');
}
function closeModal(id) { document.getElementById(id).style.display='none'; }
function showToast(msg) { 
    const t=document.getElementById('toast'); 
    t.innerText=msg; 
    t.style.display='block'; 
    t.style.animation = 'slideUp 0.3s ease';
    setTimeout(()=> { t.style.display='none'; }, 3000); 
}

</script>
</body>
</html>
