<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>PANDU-GI | Smart Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES (THEMING) --- */
        :root[data-theme="light"] {
            --primary: #2563eb; --primary-dark: #1e40af; 
            --bg: #f8fafc; --surface: #ffffff;
            --text-main: #0f172a; --text-sub: #64748b;
            --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            --card-bg: #ffffff;
        }
        
        :root[data-theme="dark"] {
            --primary: #3b82f6; --primary-dark: #60a5fa;
            --bg: #0f172a; --surface: #1e293b;
            --text-main: #f1f5f9; --text-sub: #94a3b8;
            --border: #334155; --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
            --card-bg: #1e293b;
        }

        :root {
            --danger: #ef4444; --success: #10b981; --purple: #8b5cf6; --orange: #f97316;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 80px; transition: background 0.3s, color 0.3s; }

        /* HEADER & NAVIGATION */
        .header { background: var(--surface); padding: 15px 20px; position: sticky; top: 0; z-index: 100; display: none; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-bottom: 1px solid var(--border); transition: background 0.3s; }
        .app-brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .btn-nav-back { 
            background: var(--bg); border: 1px solid var(--border); 
            color: var(--text-main); padding: 8px 14px; border-radius: 20px; 
            font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .btn-nav-back:active { transform: scale(0.95); opacity: 0.8; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; min-height: 85vh; }

        /* LOGIN SCREEN */
        #unit-select-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 90vh; padding: 20px; background: var(--bg); animation: fadeIn 0.5s ease; }
        .search-brand { font-size: 32px; font-weight: 800; color: var(--primary); margin-bottom: 30px; letter-spacing: -1px; text-align: center; }
        .search-wrapper { width: 100%; max-width: 400px; position: relative; }
        .search-box { width: 100%; background: var(--surface); border: 1px solid var(--border); box-shadow: var(--shadow); border-radius: 24px; display: flex; align-items: center; padding: 12px 20px; }
        .search-input { border: none; width: 100%; font-size: 16px; font-family: inherit; color: var(--text-main); height: 24px; padding: 0; margin: 0; background: transparent; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--surface); border-radius: 16px; box-shadow: var(--shadow); margin-top: 5px; padding: 10px 0; z-index: 10; display: none; max-height: 300px; overflow-y: auto; border: 1px solid var(--border); }
        .search-item { padding: 12px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .search-item:last-child { border-bottom: none; }
        .si-icon { width: 32px; height: 32px; background: var(--bg); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0; }

        /* DASHBOARD GRID MENU */
        .dashboard-header { margin-bottom: 25px; }
        .grid-menu { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; animation: slideUp 0.4s ease; }
        .grid-item { background: var(--card-bg); border-radius: 20px; padding: 20px 15px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: var(--shadow); border: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .grid-item:active { transform: scale(0.96); border-color: var(--primary); }
        
        .grid-icon { width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 26px; margin-bottom: 12px; }
        .grid-title { font-weight: 700; font-size: 14px; color: var(--text-main); margin-bottom: 2px; }
        .grid-desc { font-size: 11px; color: var(--text-sub); }

        .ic-blue { background: #eff6ff; color: #2563eb; } 
        .ic-green { background: #ecfdf5; color: #10b981; }
        .ic-purple { background: #f5f3ff; color: #8b5cf6; }
        .ic-orange { background: #fff7ed; color: #f97316; }
        .ic-gray { background: #f1f5f9; color: #475569; }

        [data-theme="dark"] .ic-blue { background: rgba(37,99,235,0.2); color: #60a5fa; }
        [data-theme="dark"] .ic-green { background: rgba(16,185,129,0.2); color: #34d399; }
        [data-theme="dark"] .ic-purple { background: rgba(139,92,246,0.2); color: #a78bfa; }
        [data-theme="dark"] .ic-orange { background: rgba(249,115,22,0.2); color: #fb923c; }
        [data-theme="dark"] .ic-gray { background: rgba(71,85,105,0.4); color: #cbd5e1; }

        /* SECTIONS & CARDS */
        .app-section { display: none; animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .app-section.active { display: block; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .card-title { font-size: 16px; font-weight: 800; margin: 0 0 10px 0; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        
        .data-row { margin-bottom: 8px; }
        .data-label { font-size: 11px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
        .data-val { font-size: 14px; color: var(--text-main); white-space: pre-line; }

        /* INPUTS & BUTTONS */
        input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-family: inherit; margin-bottom: 12px; font-size: 14px; background: var(--bg); color: var(--text-main); }
        .btn { border: none; padding: 12px; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; margin-bottom: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--bg); color: var(--text-main); border: 1px solid var(--border); }
        .btn-danger { background: rgba(239,68,68,0.1); color: var(--danger); border: 1px solid var(--danger); }
        
        /* PDF VIEWER */
        .pdf-modal-body { height: 100%; display: flex; flex-direction: column; }
        .pdf-frame { flex-grow: 1; width: 100%; border: none; background: #f1f5f9; }
        .pdf-header { padding: 10px 15px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }

        /* SETTINGS & TOGGLES */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .toggle-switch { position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* MODAL */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: flex-end; justify-content: center; }
        .modal { background: var(--surface); width: 100%; max-width: 500px; border-radius: 24px 24px 0 0; padding: 24px; max-height: 95vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        .modal.full-screen { height: 95vh; padding: 0; overflow: hidden; border-radius: 16px 16px 0 0; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @media (min-width: 600px) { .overlay { align-items: center; padding: 20px; } .modal { border-radius: 20px; max-height: 85vh; } }
    </style>
</head>
<body>

<div id="unit-select-screen">
    <div class="search-brand">PANDU-<span>GI</span></div>
    <div class="search-wrapper">
        <div class="search-box">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="unit-search-input" class="search-input" placeholder="Cari Gardu Induk..." autocomplete="off">
        </div>
        <div id="unit-search-results" class="search-results"></div>
    </div>
    <p style="margin-top:20px; font-size:12px; color:var(--text-sub)">Ketik nama unit atau pilih dari daftar</p>
</div>

<div class="header">
    <div class="app-brand">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 2v2"/><path d="M12 22v-2"/><path d="M2 12h2"/><path d="M22 12h-2"/></svg>
        PANDU-GI <span style="font-size:10px; background:var(--primary); color:white; padding:2px 6px; border-radius:4px; margin-left:5px;">V2</span>
    </div>
    <button id="btn-back" class="btn-nav-back" onclick="goHome()">
        <span>&larr;</span> Kembali
    </button>
</div>

<div class="container" id="app-container" style="display:none;">

    <div id="main-menu">
        <div class="dashboard-header">
            <h2 style="margin: 0; font-size: 20px; color: var(--primary);">Hallo, Petugas JARDGI</h2>
            <p style="margin: 4px 0 0 0; color: var(--text-sub); font-size: 13px;">Unit Aktif: <b id="gi-name-display">...</b></p>
            <div style="font-size:11px; color:var(--text-sub); margin-top:5px; cursor:pointer;" onclick="switchUnit()">[ Ganti Unit ]</div>
        </div>

        <div class="grid-menu">
            <div class="grid-item" onclick="openSection('section-annunciator')">
                <div class="grid-icon ic-blue">üîî</div>
                <div class="grid-title">Annunciator</div>
                <div class="grid-desc">Cari Alarm</div>
            </div>
            
            <div class="grid-item" onclick="openSection('section-sop')">
                <div class="grid-icon ic-green">üìò</div>
                <div class="grid-title">Buku SOP</div>
                <div class="grid-desc">Instruksi Kerja</div>
            </div>

            <div class="grid-item" onclick="openSection('section-asset')">
                <div class="grid-icon ic-purple">‚ö°</div>
                <div class="grid-title">Data Peralatan</div>
                <div class="grid-desc">Manual & Gambar</div>
            </div>

            <div class="grid-item" onclick="openSection('section-cloud')">
                <div class="grid-icon ic-orange">‚òÅÔ∏è</div>
                <div class="grid-title">Akses Database</div>
                <div class="grid-desc">Google Drive</div>
            </div>

            <div class="grid-item" onclick="openSection('section-backup')">
                <div class="grid-icon ic-gray">üíæ</div>
                <div class="grid-title">Backup & Restore</div>
                <div class="grid-desc">Export JSON</div>
            </div>

            <div class="grid-item" onclick="openSection('section-settings')">
                <div class="grid-icon" style="background:#f1f5f9; color:#475569;">‚ÑπÔ∏è</div>
                <div class="grid-title">Tentang</div>
                <div class="grid-desc">Aplikasi & Tema</div>
            </div>
        </div>
    </div>

    <div id="section-annunciator" class="app-section">
        <input type="text" id="search-ann" class="search-bar" placeholder="Cari Annunciator..." oninput="renderAnnunciator()">
        <button class="btn btn-primary" onclick="openModal('modal-ann')">+ Input Annunciator Baru</button>
        <div id="list-ann"></div>
    </div>

    <div id="section-sop" class="app-section">
        <div class="card">
            <h3 class="card-title">Simpan SOP Offline</h3>
            <p style="font-size:12px; color:var(--text-sub); margin-bottom:10px;">Upload file PDF agar bisa dibaca tanpa internet.</p>
            <input type="text" id="sop-name" placeholder="Judul Dokumen">
            <input type="file" id="sop-file" accept="application/pdf">
            <button class="btn btn-success" onclick="saveSOP()">Simpan PDF</button>
        </div>
        <h4 style="margin:20px 0 10px 5px; color:var(--text-sub); font-size:12px; text-transform:uppercase;">Daftar SOP Tersimpan</h4>
        <div id="list-sop"></div>
    </div>

    <div id="section-asset" class="app-section">
        <div class="card">
            <h3 class="card-title">Simpan Data Peralatan</h3>
            <p style="font-size:12px; color:var(--text-sub); margin-bottom:10px;">Upload Manual Book/Gambar Teknik (PDF).</p>
            <input type="text" id="asset-name" placeholder="Judul Dokumen">
            <input type="file" id="asset-file" accept="application/pdf">
            <button class="btn btn-purple" onclick="saveAsset()">Simpan PDF</button>
        </div>
        <h4 style="margin:20px 0 10px 5px; color:var(--text-sub); font-size:12px; text-transform:uppercase;">File Tersimpan</h4>
        <div id="list-asset"></div>
    </div>

    <div id="section-cloud" class="app-section">
        <div class="card">
            <div style="text-align:center; padding:20px;">
                <div style="font-size:48px; margin-bottom:10px;">üìÇ</div>
                <h3 style="margin:0; color:var(--text-main)">Google Drive Utama</h3>
                <p style="color:var(--text-sub); font-size:13px; margin:5px 0 20px 0;">Pusat penyimpanan seluruh data Gardu Induk.</p>
                <button class="btn btn-primary" onclick="openGDrive()">Buka Folder Drive ‚ÜóÔ∏è</button>
            </div>
            
            <div style="border-top:1px solid var(--border); padding-top:15px; margin-top:15px;">
                <label class="data-label">Link Folder Drive</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="in-gdrive-link" placeholder="Paste link..." style="margin:0">
                    <button class="btn btn-secondary" onclick="saveGDriveLink()" style="width:auto; margin:0">Set</button>
                </div>
            </div>
        </div>
    </div>

    <div id="section-backup" class="app-section">
        <div class="card">
            <h3 class="card-title">Export & Import</h3>
            <p style="font-size:12px; color:var(--text-sub);">Amankan data aplikasi ke format JSON.</p>
            <button class="btn btn-primary" onclick="exportData()">Export Data JSON ‚¨áÔ∏è</button>
            
            <div style="margin-top:20px; padding-top:15px; border-top:1px dashed var(--border);">
                <label class="data-label">Restore Data</label>
                <input type="file" id="import-file" accept=".json">
                <button class="btn btn-success" onclick="importData(document.getElementById('import-file'))">Restore Data JSON</button>
            </div>
        </div>
        
        <div class="card" style="border-color:var(--danger); background:rgba(239,68,68,0.05);">
            <h3 class="card-title" style="color:var(--danger)">Danger Zone</h3>
            <button class="btn btn-danger" onclick="resetApp()">Reset / Hapus Data Unit Ini</button>
        </div>
    </div>

    <div id="section-settings" class="app-section">
        <div class="card">
            <h3 class="card-title">Tampilan</h3>
            <div class="toggle-row">
                <span>Mode Gelap (Dark Mode)</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title">Tentang Aplikasi</h3>
            <div style="text-align:center; padding:10px;">
                <h4 style="margin:0; color:var(--primary);">PANDU-GI</h4>
                <div style="font-size:12px; font-weight:700; color:var(--text-sub); margin-bottom:15px;">Pusat Bantuan Digital Unit Gardu Induk</div>
                <p style="font-size:13px; line-height:1.6; color:var(--text-main);">
                    "PANDU-GI hadir sebagai terobosan cerdas untuk era digitalisasi energi. Aplikasi ini dirancang untuk memastikan efisiensi operasional, kecepatan akses data, dan keandalan sistem dalam satu genggaman."
                </p>
                <div style="font-size:11px; color:var(--text-sub); margin-top:20px;">Versi 2.0 (Hybrid System)</div>
            </div>
        </div>
    </div>

</div>

<div id="modal-ann" class="overlay">
    <div class="modal">
        <h3>Form Annunciator</h3>
        <input type="hidden" id="ann-id"> 
        <label class="data-label">Unit / Bay</label>
        <input type="text" id="ann-unit" placeholder="Misal: Trafo 1">
        <label class="data-label">Nama Annunciator</label>
        <input type="text" id="ann-name" placeholder="Judul...">
        <label class="data-label">Indikasi</label>
        <textarea id="ann-ind" rows="2" placeholder="Indikasi Alarm"></textarea>
        <label class="data-label">Penyebab</label>
        <textarea id="ann-cause" rows="2"></textarea>
        <label class="data-label">Tindakan</label>
        <textarea id="ann-action" rows="2"></textarea>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-primary" onclick="saveAnnItem()">Simpan</button>
            <button class="btn btn-secondary" onclick="closeModal('modal-ann')">Batal</button>
        </div>
    </div>
</div>

<div id="modal-viewer" class="overlay">
    <div class="modal full-screen">
        <div class="pdf-modal-body">
            <div class="pdf-header">
                <span style="font-weight:700; font-size:14px;" id="viewer-title">Dokumen</span>
                <button style="background:none; border:none; font-size:18px; cursor:pointer; color:var(--text-main);" onclick="closeModal('modal-viewer')">‚úï Tutup</button>
            </div>
            <iframe id="pdf-frame" class="pdf-frame"></iframe>
        </div>
    </div>
</div>

<div id="loader" style="display:none;"><div class="spinner"></div></div>
<div id="toast-container"></div>

<script>
// CONFIG
const UNITS = [
    { id: 'fajar', name: 'GARDU INDUK 150 KV FAJAR SURYAWISESA', code: 'FJS' },
    { id: 'gandamekar', name: 'GARDU INDUK 150 KV GANDAMEKAR', code: 'GDM' },
    { id: 'cikarang', name: 'GARDU INDUK 150 KV CIKARANG', code: 'CKR' },
    { id: 'jababeka', name: 'GARDU INDUK 150 KV JABABEKA', code: 'JBK' },
    { id: 'rajapaksi', name: 'GARDU INDUK 150 KV RAJAPAKSI', code: 'RJP' },
    { id: 'poncol', name: 'GARDU INDUK 150 KV PONCOL BARU', code: 'PCB' },
    { id: 'tambun', name: 'GARDU INDUK 150 KV TAMBUN', code: 'TBN' },
    { id: 'margahayu', name: 'GIS 150 KV MARGAHAYU', code: 'MGH' },
    { id: 'new_tambun_tet', name: 'GISTET 500 KV NEW TAMBUN', code: 'NTB' },
    { id: 'muaratawar', name: 'GITET 500 KV MUARATAWAR', code: 'MRT' },
    { id: 'new_tambun_gis', name: 'GIS 150 KV NEW TAMBUN', code: 'NTG' }
];

const MASTER_DRIVE_LINK = "https://drive.google.com/drive/folders/13vT0iXCJLjer9sMS5VWI5jjchFk4ntmo?usp=sharing";

// STATE
let currentUnit = null;
let db = { anns: [], contacts: [] }; 
let idb;
let driveLink = "";

document.addEventListener('DOMContentLoaded', () => {
    setupSearchEngine();
    checkSession();
    // Load theme
    const theme = localStorage.getItem('pandu_theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('theme-toggle').checked = (theme === 'dark');
});

// SEARCH & LOGIN
function setupSearchEngine() {
    const input = document.getElementById('unit-search-input');
    const results = document.getElementById('unit-search-results');
    const wrapper = document.querySelector('.search-box');
    input.addEventListener('focus', () => { wrapper.style.borderRadius="24px 24px 0 0"; renderSearchResults(input.value); results.style.display='block'; });
    input.addEventListener('input', (e) => { renderSearchResults(e.target.value); });
    document.addEventListener('click', (e) => { if (!e.target.closest('.search-wrapper')) { results.style.display='none'; wrapper.style.borderRadius="24px"; } });
}
function renderSearchResults(k) {
    const list = document.getElementById('unit-search-results'); list.innerHTML = '';
    const filtered = UNITS.filter(u => u.name.toLowerCase().includes(k.toLowerCase()));
    if (filtered.length === 0) return list.innerHTML = `<div class="search-item" style="color:var(--text-sub);justify-content:center">Tidak ditemukan</div>`;
    filtered.forEach(u => {
        const div = document.createElement('div'); div.className = 'search-item';
        div.innerHTML = `<div class="si-icon">${u.code}</div><div><div style="font-weight:600; font-size:14px; color:var(--text-main)">${u.name}</div><div style="font-size:11px;color:var(--text-sub)">Tap untuk masuk</div></div>`;
        div.onclick = () => login(u.id); list.appendChild(div);
    });
}
function checkSession() {
    const last = localStorage.getItem('pandu_active_unit');
    if (last) login(last, false); else { document.getElementById('unit-select-screen').style.display='flex'; document.getElementById('app-container').style.display='none'; document.querySelector('.header').style.display='none'; }
}
function login(unitId) {
    const unit = UNITS.find(u => u.id === unitId); if(!unit) return;
    currentUnit = unit; localStorage.setItem('pandu_active_unit', unitId);
    
    // DB LOAD
    const saved = localStorage.getItem(`pandu_db_${unitId}`);
    if (saved) {
        let t = JSON.parse(saved);
        if(t.alarms) { t.anns = t.alarms.map(x=>({id:x.id||Date.now(), unit:x.s, name:x.a, ind:x.m, cause:x.p, act:x.t})); delete t.alarms; }
        db = t; if(!db.anns) db.anns=[];
    } else db = { anns: [], contacts: [] };

    driveLink = localStorage.getItem(`pandu_drive_${unitId}`) || MASTER_DRIVE_LINK;
    document.getElementById('in-gdrive-link').value = driveLink;

    initIndexedDB(unitId);
    document.getElementById('header-gi-name').innerText = unit.code;
    document.getElementById('gi-name-display').innerText = unit.name;
    document.getElementById('unit-select-screen').style.display='none';
    document.getElementById('app-container').style.display='block';
    document.querySelector('.header').style.display='flex';
    goHome(); 
}
function switchUnit() { if(confirm("Ganti unit?")) { localStorage.removeItem('pandu_active_unit'); location.reload(); } }
function saveData() { if(!currentUnit) return; localStorage.setItem(`pandu_db_${currentUnit.id}`, JSON.stringify(db)); }

// THEME
function toggleTheme() {
    const isDark = document.getElementById('theme-toggle').checked;
    const theme = isDark ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('pandu_theme', theme);
}

// DRIVE LINKS
function saveGDriveLink() {
    const val = document.getElementById('in-gdrive-link').value;
    localStorage.setItem(`pandu_drive_${currentUnit.id}`, val);
    driveLink = val; showToast("Link tersimpan");
}
function openGDrive() {
    if(driveLink) window.open(driveLink, '_blank');
    else window.open(MASTER_DRIVE_LINK, '_blank');
}

// INDEXED DB & FILES
function initIndexedDB(unitId) {
    const req = indexedDB.open(`PanduGI_${unitId}`, 1);
    req.onupgradeneeded = e => { const d = e.target.result; 
        if(!d.objectStoreNames.contains('sops')) d.createObjectStore("sops",{keyPath:"id",autoIncrement:true}); 
        if(!d.objectStoreNames.contains('assets')) d.createObjectStore("assets",{keyPath:"id",autoIncrement:true}); 
    };
    req.onsuccess = e => { idb = e.target.result; };
}

function saveFile(store, nameId, fileId, renderFunc) {
    const name = document.getElementById(nameId).value; const file = document.getElementById(fileId).files[0];
    if(!name || !file) return showToast("Lengkapi data!", true);
    if(file.size > 15*1024*1024) return showToast("Maks 15 MB!", true);
    
    document.getElementById('loader').style.display = 'flex';
    // Cek Duplikat
    const tx = idb.transaction(store, "readonly");
    const req = tx.objectStore(store).getAll();
    req.onsuccess = (e) => {
        const files = e.target.result;
        const exists = files.find(f => f.name.toLowerCase() === name.toLowerCase());
        
        if (exists) {
            if(!confirm(`File "${name}" sudah ada. Timpa (Overwrite)?`)) {
                document.getElementById('loader').style.display = 'none'; return;
            }
            const delTx = idb.transaction(store, "readwrite");
            delTx.objectStore(store).delete(exists.id);
        }
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const wTx = idb.transaction(store, "readwrite");
                wTx.objectStore(store).add({ name: name, blob: new Blob([e.target.result], {type: 'application/pdf'}), date: new Date().toLocaleDateString() });
                wTx.oncomplete = () => { document.getElementById('loader').style.display = 'none'; showToast("Tersimpan Offline!"); document.getElementById(nameId).value=""; document.getElementById(fileId).value=""; renderFunc(); };
                wTx.onerror = () => { document.getElementById('loader').style.display = 'none'; showToast("Gagal (Memori Penuh?)", true); };
            } catch(err) { document.getElementById('loader').style.display = 'none'; showToast("Error Sistem", true); }
        };
        reader.readAsArrayBuffer(file);
    };
}

function renderFile(store, listId, delFunc) {
    const list = document.getElementById(listId); list.innerHTML = "<div class='spinner' style='width:20px;height:20px;margin:10px auto'></div>";
    if(!idb) { setTimeout(() => renderFile(store, listId, delFunc), 500); return; }
    const tx = idb.transaction(store, "readonly");
    tx.objectStore(store).getAll().onsuccess = e => {
        const res = e.target.result; res.sort((a,b)=>b.id-a.id);
        list.innerHTML = res.length ? "" : "<div class='empty-state'>Belum ada file offline.</div>";
        res.forEach(f => {
            list.innerHTML += `<div class="card" style="display:flex;justify-content:space-between;align-items:center; padding:12px;"><div style="overflow:hidden;padding-right:10px"><div class="data-val" style="margin:0;font-weight:700">${f.name}</div><div class="data-label" style="font-size:10px;margin-top:2px">${f.date}</div></div><div style="display:flex;gap:5px"><button class="btn btn-secondary" style="margin:0;padding:6px 10px; width:auto;" onclick="openFile('${store}',${f.id}, '${f.name}')">Buka</button><button class="btn btn-danger" style="margin:0;padding:6px 10px; width:auto;" onclick="${delFunc}(${f.id})">‚úï</button></div></div>`;
        });
    };
}

function openFile(store, id, name) {
    document.getElementById('loader').style.display = 'flex';
    idb.transaction(store, "readonly").objectStore(store).get(id).onsuccess = e => {
        document.getElementById('loader').style.display = 'none';
        if(e.target.result) {
            const url = URL.createObjectURL(e.target.result.blob);
            document.getElementById('viewer-title').innerText = name;
            document.getElementById('pdf-frame').src = url;
            document.getElementById('modal-viewer').style.display = 'flex';
        } else showToast("Gagal buka", true);
    };
}

function delFile(store, id, renderFunc) {
    if(confirm("Hapus file offline ini?")) { idb.transaction(store, "readwrite").objectStore(store).delete(id).onsuccess = () => renderFunc(); }
}
function saveSOP() { saveFile('sops', 'sop-name', 'sop-file', renderSOP); } function renderSOP() { renderFile('sops', 'list-sop', 'delSOP'); } function delSOP(id) { delFile('sops', id, renderSOP); }
function saveAsset() { saveFile('assets', 'asset-name', 'asset-file', renderAsset); } function renderAsset() { renderFile('assets', 'list-asset', 'delAsset'); } function delAsset(id) { delFile('assets', id, renderAsset); }

// UTILS
function showToast(msg, isError=false) {
    const c = document.getElementById('toast-container'); const e = document.createElement('div'); e.className = `toast ${isError?'error':''}`; e.innerText = msg;
    c.appendChild(e); setTimeout(() => { e.style.opacity='0'; setTimeout(()=>e.remove(),300); }, 3000);
}
function toggleLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
function goHome() { document.querySelectorAll('.app-section').forEach(e=>e.classList.remove('active')); document.getElementById('main-menu').style.display='block'; document.getElementById('btn-back').style.display='none'; }
function openSection(id) { 
    document.getElementById('main-menu').style.display='none'; document.getElementById(id).classList.add('active'); document.getElementById('btn-back').style.display='flex'; 
    if(id==='section-annunciator') renderAnnunciator(); 
    if(id==='section-sop') renderSOP();
    if(id==='section-asset') renderAsset();
}

// DATA LOGIC
function renderAnnunciator() {
    const list = document.getElementById('list-ann'); const k = document.getElementById('search-ann').value.toLowerCase(); list.innerHTML = "";
    const f = db.anns.filter(x => (x.unit+" "+x.name+" "+x.ind+" "+x.cause+" "+x.act).toLowerCase().includes(k));
    if(f.length===0) return list.innerHTML = "<div class='empty-state'>Tidak ada data.</div>";
    f.forEach(i => {
        list.innerHTML += `<div class="card"><div class="action-group"><button class="icon-btn" onclick="editAnn('${i.id}')">‚úèÔ∏è</button><button class="icon-btn" onclick="delAnn('${i.id}')" style="color:var(--danger)">üóëÔ∏è</button></div><div class="badge">${i.unit}</div><div class="card-title">${i.name}</div><div class="data-row"><div class="data-label">Indikasi</div><div class="data-val">${i.ind||'-'}</div></div><div class="data-row"><div class="data-label">Penyebab</div><div class="data-val">${i.cause||'-'}</div></div><div class="data-row"><div class="data-label">Tindakan</div><div class="data-val">${i.act||'-'}</div></div></div>`;
    });
}
function saveAnnItem() {
    const id = document.getElementById('ann-id').value;
    const item = { id: id||Date.now().toString(), unit: document.getElementById('ann-unit').value, name: document.getElementById('ann-name').value, ind: document.getElementById('ann-ind').value, cause: document.getElementById('ann-cause').value, act: document.getElementById('ann-action').value };
    if(!item.unit || !item.name) return showToast("Lengkapi data!", true);
    if(id) { const i = db.anns.findIndex(x=>x.id==id); if(i!==-1) db.anns[i]=item; } else db.anns.unshift(item);
    saveData(); closeModal('modal-ann'); renderAnnunciator(); showToast("Tersimpan!");
}
function editAnn(id) {
    const i = db.anns.find(x=>x.id==id); if(!i) return;
    document.getElementById('ann-id').value=i.id; document.getElementById('ann-unit').value=i.unit; document.getElementById('ann-name').value=i.name; document.getElementById('ann-ind').value=i.ind; document.getElementById('ann-cause').value=i.cause; document.getElementById('ann-action').value=i.act;
    openModal('modal-ann');
}
function delAnn(id) { if(confirm("Hapus?")) { db.anns = db.anns.filter(x=>x.id!=id); saveData(); renderAnnunciator(); } }

function exportData() { const s=JSON.stringify(db,null,2); const b=new Blob([s],{type:"application/json"}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`BACKUP_${currentUnit.code}.json`; document.body.appendChild(a); a.click(); a.remove(); }
function importData(inp) { const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ try { const j=JSON.parse(e.target.result); if(confirm(`Timpa data?`)) { if(j.alarms) { j.anns=j.alarms.map(x=>({id:x.id,unit:x.s,name:x.a,ind:x.m,cause:x.p,act:x.t})); delete j.alarms; } db=j; saveData(); location.reload(); } } catch(e){showToast("File rusak",true);} }; r.readAsText(f); }
function resetApp() { if(confirm("RESET TOTAL?")) { localStorage.removeItem(`pandu_db_${currentUnit.id}`); localStorage.removeItem(`pandu_drive_${currentUnit.id}`); indexedDB.deleteDatabase(`PanduGI_${currentUnit.id}`).onsuccess=()=>location.reload(); } }

function openModal(id) { document.getElementById(id).style.display='flex'; if(id==='modal-ann') ['ann-id','ann-unit','ann-name','ann-ind','ann-cause','ann-action'].forEach(k=>document.getElementById(k).value=""); }
function closeModal(id) { document.getElementById(id).style.display='none'; }
window.onclick = e => { if(e.target.classList.contains('overlay')) e.target.style.display="none"; }
</script>
</body>
</html>
